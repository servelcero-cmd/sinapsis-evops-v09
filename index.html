<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo Sinapsis v0.9 - Activa Consultores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .state-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .state-pending { background: #FEF3C7; color: #92400E; }
        .state-active { background: #DBEAFE; color: #1E40AF; }
        .state-completed { background: #DCFCE7; color: #166534; }
        .state-blocked { background: #FEE2E2; color: #991B1B; }
        
        .ai-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .ai-gemini { background: #DDD6FE; color: #4338CA; }
        .ai-gpt4 { background: #E0E7FF; color: #3730A3; }
        .ai-claude { background: #FEE2E2; color: #7F1D1D; }
        .ai-deepseek { background: #F0FDF4; color: #15803D; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .task-card, .kpi-card { transition: all 0.3s ease; }
        .task-card:hover, .kpi-card:hover { transform: translateY(-2px); }
        .success-flash { animation: pulse 0.5s ease-in-out; }
        .history-entry { opacity: 0; animation: slideIn 0.3s ease-out forwards; }
        .shortcuts-modal { backdrop-filter: blur(4px); }
        .loop-badge { background: #FEF3C7; color: #92400E; border: 1px solid #F59E0B; animation: pulse 2s ease-in-out infinite; }
        .suggestion-badge { background: #DBEAFE; color: #1E40AF; border: 1px solid #3B82F6; }
        .synaptic-score, .gradient-text { font-size: 2rem; font-weight: bold; background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .chart-bar { transition: width 0.5s ease, background 0.3s ease; }
        .chart-bar:hover { filter: brightness(1.2); }

        .kpi-card { border-left: 4px solid transparent; }
        .kpi-excellent { border-left-color: #10B981; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%); }
        .kpi-good { border-left-color: #3B82F6; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); }
        .kpi-warning { border-left-color: #F59E0B; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%); }
        .kpi-critical { border-left-color: #EF4444; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%); }

        .main-nav-tab {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        .main-nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .main-nav-tab:not(.active) {
            color: #9ca3af;
        }
        .main-nav-tab:not(.active):hover {
            background: rgba(102, 126, 234, 0.1);
            color: #d1d5db;
        }
    </style>

<style>
.btn{cursor:pointer;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px 12px;background:rgba(255,255,255,.06);color:#e8eefc;font-weight:800}
.btn.primary{border-color:rgba(31,111,235,.55);background:rgba(31,111,235,.18)}
.btn.orange{border-color:rgba(255,122,26,.55);background:rgba(255,122,26,.14)}
</style>


<style>
  /* --- PDF comit√© (Print) --- */
  @media print {
    table, tr { page-break-inside: avoid; break-inside: avoid; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    body { background: white !important; color: #111 !important; }
    .no-print { display: none !important; }
    #sinapsisPrintReport { display: block !important; }
  }
  #sinapsisPrintReport {
    display:none;
    padding:24px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  #sinapsisPrintReport h1 { margin:0 0 6px 0; font-size:20px; }
  #sinapsisPrintReport .brandA { color:#1f6feb; font-weight:900; }
  #sinapsisPrintReport .brandC { color:#ff7a1a; font-weight:900; }
  #sinapsisPrintReport .muted { color:#4b5563; font-size:12px; }
  #sinapsisPrintReport .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px; }
  #sinapsisPrintReport .kpi { border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
  #sinapsisPrintReport .kpi .t { color:#6b7280; font-size:12px; font-weight:800; }
  #sinapsisPrintReport .kpi .v { font-size:18px; font-weight:900; margin-top:4px; }

  #sinapsisPrintReport .sectionTitle { margin-top:14px; font-size:13px; font-weight:900; }
  #sinapsisPrintReport .stationTable { margin-top:8px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
  #sinapsisPrintReport .row { display:flex; gap:10px; padding:8px 10px; border-top:1px solid #f3f4f6; font-size:12px; line-height:1.2; }
  #sinapsisPrintReport .row.head { background:#f9fafb; font-weight:900; border-top:none; }
  #sinapsisPrintReport .cell { flex:1; min-width:0; }
  #sinapsisPrintReport .cell.small { flex:0 0 68px; text-align:right; font-variant-numeric: tabular-nums; }
  #sinapsisPrintReport .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-weight:800; font-size:11px; }
  #sinapsisPrintReport .b-offline { background:#fff1f2; border-color:#fecdd3; }
  #sinapsisPrintReport .b-queue { background:#fff7ed; border-color:#fed7aa; }
  #sinapsisPrintReport .b-occupied { background:#eff6ff; border-color:#bfdbfe; }
  #sinapsisPrintReport .b-available { background:#ecfdf5; border-color:#bbf7d0; }

</style>


<style>
/* --- v5.3 Print patch: evitar recorte del detalle por estaci√≥n --- */
@media print {
    table, tr { page-break-inside: avoid; break-inside: avoid; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

  #sinapsisPrintReport .stationTable { overflow: visible !important; }
  #sinapsisPrintReport .stationTable, 
  #sinapsisPrintReport .stationTable * { break-inside: auto !important; page-break-inside: auto !important; }
  #sinapsisPrintReport .stationRow { break-inside: avoid !important; page-break-inside: avoid !important; }
  #sinapsisPrintReport .stationHead { break-inside: avoid !important; page-break-inside: avoid !important; }
}
</style>

</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        console.log('üü¢ ===== PROTOCOLO SINAPSIS v0.9 =====');
        console.log('üì¶ Incluye datos pre-cargados para evaluaci√≥n');

        // ============================================
        // UTILITIES
        // ============================================
        const getTimeAgo = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'hace un momento';
            if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} h`;
            return `hace ${Math.floor(seconds / 86400)} d√≠as`;
        };

        const formatDateTime = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // ============================================
        // v0.7 INTELLIGENCE SYSTEMS (for Projects Module)
        // ============================================

        // LOOP DETECTION SYSTEM
        const detectLoops = (task) => {
            const loops = [];
            const now = Date.now();
            const lastModified = new Date(task.lastModified).getTime();
            const daysSinceModified = (now - lastModified) / (1000 * 60 * 60 * 24);

            // Check 1: Stagnant progress (>3 days without change)
            if (daysSinceModified > 3 && task.status !== 'completed' && task.status !== 'skipped') {
                loops.push({
                    type: 'stagnant',
                    severity: 'warning',
                    message: `Sin cambios en ${Math.floor(daysSinceModified)} d√≠as`,
                    suggestion: 'Revisar progreso o cambiar especialista'
                });
            }

            // Check 2: Oscillating states (multiple state changes)
            const stateChanges = task.history?.filter(h => h.event === 'status_change') || [];
            if (stateChanges.length >= 3) {
                const recent = stateChanges.slice(-3);
                const hasOscillation = recent.some((change, i) => 
                    i > 0 && (
                        (change.details.includes('active') && recent[i-1].details.includes('blocked')) ||
                        (change.details.includes('blocked') && recent[i-1].details.includes('active'))
                    )
                );
                
                if (hasOscillation) {
                    loops.push({
                        type: 'oscillating',
                        severity: 'error',
                        message: `${stateChanges.length} cambios de estado`,
                        suggestion: 'Revisar causa ra√≠z del problema'
                    });
                }
            }

            // Check 3: Stuck specialist (same AI without progress)
            const aiChanges = task.history?.filter(h => h.event === 'ai_assigned') || [];
            if (aiChanges.length === 0 && daysSinceModified > 2 && task.progress < 50) {
                loops.push({
                    type: 'stuck',
                    severity: 'warning',
                    message: 'Especialista podr√≠a estar en l√≠mites',
                    suggestion: 'Probar cross-pollination'
                });
            }

            return loops;
        };

        // INTELLIGENT SUGGESTIONS SYSTEM
        const specialistKeywords = {
            gemini: ['arquitectura', 'dise√±o', 'sistema', 'estructura', 'diagrama', 'planificaci√≥n', 'estrategia', 'dashboard', 'visualizaci√≥n'],
            gpt4: ['creativo', 'innovaci√≥n', 'marketing', 'contenido', 'copy', 'ideaci√≥n', 'campa√±a', 'storytelling', 'optimizaci√≥n'],
            claude: ['an√°lisis', 'datos', 'investigaci√≥n', 'evaluaci√≥n', 'profundo', 'cr√≠tico', 'review', 'patrones', 'insights'],
            deepseek: ['implementaci√≥n', 'c√≥digo', 't√©cnico', 'desarrollo', 'testing', 'debug', 'algoritmo', 'modelo', 'predictivo']
        };

        const suggestSpecialist = (taskName, taskNotes = '') => {
            const text = (taskName + ' ' + taskNotes).toLowerCase();
            const scores = {};

            Object.keys(specialistKeywords).forEach(specialist => {
                const keywords = specialistKeywords[specialist];
                let score = 0;
                keywords.forEach(keyword => {
                    if (text.includes(keyword.toLowerCase())) {
                        score += 1;
                    }
                });
                scores[specialist] = score;
            });

            // Get highest score
            const maxScore = Math.max(...Object.values(scores));
            if (maxScore === 0) return null;

            const suggested = Object.keys(scores).find(s => scores[s] === maxScore);
            return suggested;
        };

        // ANALYTICS SYSTEM
        const calculateAnalytics = (project) => {
            if (!project || !project.tasks || project.tasks.length === 0) {
                return {
                    totalTasks: 0,
                    completedTasks: 0,
                    averageTimePerTask: 0,
                    specialistUsage: { gemini: 0, gpt4: 0, claude: 0, deepseek: 0 },
                    crossPollinationCount: 0,
                    synapsisScore: 0,
                    insights: []
                };
            }

            const totalTasks = project.tasks.length;
            const completedTasks = project.tasks.filter(t => t.status === 'completed').length;
            const activeTasks = project.tasks.filter(t => t.status === 'active').length;
            const blockedTasks = project.tasks.filter(t => t.status === 'blocked').length;

            // Average time per completed task
            const completedWithTime = project.tasks.filter(t => t.status === 'completed');
            let avgTime = 0;
            if (completedWithTime.length > 0) {
                avgTime = completedWithTime.reduce((acc, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.lastModified);
                    const days = (completed - created) / (1000 * 60 * 60 * 24);
                    return acc + days;
                }, 0) / completedWithTime.length;
            }

            // Specialist usage
            const specialistUsage = {
                gemini: 0,
                gpt4: 0,
                claude: 0,
                deepseek: 0
            };
            project.tasks.forEach(task => {
                if (specialistUsage[task.assignedAI] !== undefined) {
                    specialistUsage[task.assignedAI]++;
                }
            });

            // Cross-pollination count
            let crossPollinationCount = 0;
            project.tasks.forEach(task => {
                const aiChanges = task.history?.filter(h => h.event === 'ai_assigned') || [];
                if (aiChanges.length > 1) {
                    crossPollinationCount += aiChanges.length - 1;
                }
            });

            // Synaptic Score (0-100)
            const completionRate = (completedTasks / totalTasks) * 100 || 0;
            const crossPollRate = Math.min((crossPollinationCount / totalTasks) * 20, 20) || 0;
            const timeEfficiency = avgTime < 5 ? 20 : avgTime < 10 ? 10 : avgTime < 20 ? 5 : 0;
            const diversityScore = Object.values(specialistUsage).filter(v => v > 0).length * 5;
            const synapsisScore = Math.min(100, Math.round(
                completionRate * 0.5 + 
                crossPollRate + 
                timeEfficiency + 
                diversityScore
            ));

            // Generate insights
            const insights = [];
            if (completionRate > 70) {
                insights.push({ type: 'success', text: `Excelente tasa de completitud: ${Math.round(completionRate)}%` });
            } else if (completionRate < 30) {
                insights.push({ type: 'warning', text: `Baja tasa de completitud: ${Math.round(completionRate)}%` });
            }

            if (crossPollinationCount > 0) {
                insights.push({ type: 'info', text: `${crossPollinationCount} casos de cross-pollination efectiva` });
            }

            if (blockedTasks > 0) {
                insights.push({ type: 'error', text: `${blockedTasks} tarea(s) bloqueada(s) requieren atenci√≥n` });
            }

            if (avgTime > 0) {
                insights.push({ type: 'info', text: `Tiempo promedio por tarea: ${avgTime.toFixed(1)} d√≠as` });
            }

            const mostUsedSpecialist = Object.keys(specialistUsage).reduce((a, b) => 
                specialistUsage[a] > specialistUsage[b] ? a : b
            );
            if (specialistUsage[mostUsedSpecialist] > 0) {
                insights.push({ type: 'info', text: `Especialista m√°s usado: ${mostUsedSpecialist}` });
            }

            return {
                totalTasks,
                completedTasks,
                activeTasks,
                blockedTasks,
                averageTimePerTask: avgTime,
                specialistUsage,
                crossPollinationCount,
                synapsisScore,
                insights
            };
        };

        // ============================================
        // STATE MACHINE CORE
        // ============================================
        const StateTransitions = {
            'pending': ['active', 'skipped'],
            'active': ['completed', 'blocked'],
            'blocked': ['active', 'skipped'],
            'completed': [],
            'skipped': []
        };

        // ============================================
        // DATA MODELS
        // ============================================
        const AISpecialists = [
            { id: 'gemini', name: 'Gemini', role: 'El Arquitecto', color: 'bg-purple-100 text-purple-800 border-purple-300' },
            { id: 'gpt4', name: 'GPT-4', role: 'El Innovador', color: 'bg-blue-100 text-blue-800 border-blue-300' },
            { id: 'claude', name: 'Claude', role: 'El Analista', color: 'bg-red-100 text-red-800 border-red-300' },
            { id: 'deepseek', name: 'DeepSeek', role: 'El Especialista', color: 'bg-green-100 text-green-800 border-green-300' }
        ];

        // ============================================
        // STORAGE HELPERS (Unified for Projects and KPI)
        // ============================================
        const StorageOps = {
            // PROJECT STORAGE
            saveProject: (project) => {
                try {
                    const key = `sinapsis-project-${project.id}`;
                    const jsonString = JSON.stringify(project);
                    localStorage.setItem(key, jsonString);
                    window.dispatchEvent(new CustomEvent('sinapsis:projectsUpdated'));
                    console.log(`‚úÖ GUARDADO OK: ${key}`);
                    return true;
                } catch (e) {
                    console.error('‚ùå Storage save failed:', e);
                    return false;
                }
            },
            
            loadProject: (projectId) => {
                try {
                    const key = `sinapsis-project-${projectId}`;
                    const data = localStorage.getItem(key);
                    if (data) {
                        return JSON.parse(data);
                    }
                    return null;
                } catch (e) {
                    console.error('‚ùå Storage load failed:', e);
                    return null;
                }
            },
            
            loadAllProjects: () => {
                try {
                    const projects = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('sinapsis-project-')) {
                            const data = localStorage.getItem(key);
                            if (!data) continue;
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed && parsed.id) projects.push(parsed);
                            } catch (parseErr) {
                                console.warn('‚ö†Ô∏è Proyecto con JSON inv√°lido (se omite):', key, parseErr);
                            }
                        }
                    }
                    // Orden: m√°s recientes primero (si existe createdAt)
                    projects.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    return projects;
                } catch (e) {
                    console.error('‚ùå Storage loadAll failed:', e);
                    return [];
                }
            }
            },
            
            deleteProject: (projectId) => {
                try {
                    const key = `sinapsis-project-${projectId}`;
                    localStorage.removeItem(key);
                    window.dispatchEvent(new CustomEvent('sinapsis:projectsUpdated'));
                    console.log(`üóëÔ∏è ELIMINADO: ${key}`);
                    return true;
                } catch (e) {
                    console.error('‚ùå Storage delete failed:', e);
                    return false;
                }
            },

            exportProject: (project) => {
                try {
                    const dataStr = JSON.stringify(project, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `sinapsis-${project.name.replace(/\s+/g, '-')}-${Date.now()}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    return true;
                } catch (e) {
                    console.error('‚ùå Export failed:', e);
                    return false;
                }
            },

            importProject: (fileContent) => {
                try {
                    const project = JSON.parse(fileContent);
                    if (!project.id || !project.name || !Array.isArray(project.tasks)) {
                        throw new Error('Formato de proyecto inv√°lido');
                    }
                    return project;
                } catch (e) {
                    console.error('‚ùå Import failed:', e);
                    throw e;
                }
            },

            // KPI STORAGE
            saveKPIReport: (report) => {
                try {
                    const key = `sinapsis-kpi-${report.id}`;
                    localStorage.setItem(key, JSON.stringify(report));
                    console.log(`‚úÖ KPI Report saved: ${key}`);
                    return true;
                } catch (e) {
                    console.error('‚ùå KPI save failed:', e);
                    return false;
                }
            },

            loadAllKPIReports: () => {
                try {
                    const reports = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('sinapsis-kpi-')) {
                            const data = localStorage.getItem(key);
                            if (data) {
                                reports.push(JSON.parse(data));
                            }
                        }
                    }
                    return reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } catch (e) {
                    console.error('‚ùå KPI loadAll failed:', e);
                    return [];
                }
            },

            deleteKPIReport: (reportId) => {
                try {
                    const key = `sinapsis-kpi-${reportId}`;
                    localStorage.removeItem(key);
                    console.log(`üóëÔ∏è KPI Report deleted: ${key}`);
                    return true;
                } catch (e) {
                    console.error('‚ùå KPI delete failed:', e);
                    return false;
                }
            },

            // ============================================
            // EV OPS STORAGE (DEMO)
            // ============================================
            saveEVStation: (station) => {
                try {
                    const key = `sinapsis-ev-station-${station.id}`;
                    localStorage.setItem(key, JSON.stringify(station));
                    return true;
                } catch (e) {
                    console.error('‚ùå EV save failed:', e);
                    return false;
                }
            },

            loadAllEVStations: () => {
                try {
                    const stations = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('sinapsis-ev-station-')) {
                            const raw = localStorage.getItem(key);
                            if (raw) stations.push(JSON.parse(raw));
                        }
                    }
                    return stations.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                } catch (e) {
                    console.error('‚ùå EV loadAll failed:', e);
                    return [];
                }
            },

            deleteEVStation: (stationId) => {
                try {
                    const key = `sinapsis-ev-station-${stationId}`;
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('‚ùå EV delete failed:', e);
                    return false;
                }
            },

            exportEVStations: (stations) => {
                try {
                    const dataStr = JSON.stringify(stations, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sinapsis-ev-stations-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    return true;
                } catch (e) {
                    console.error('‚ùå EV export failed:', e);
                    return false;
                }
            }

        };

        // ============================================
        // KPI ENGINE
        // ============================================
        const calculateKPIs = (data) => {
            const roiMarketing = data.marketingInvestment > 0 
                ? (((data.revenue - data.marketingInvestment) / data.marketingInvestment) * 100).toFixed(2)
                : 0;
            const grossMargin = data.revenue > 0
                ? (((data.revenue - data.costOfSales) / data.revenue) * 100).toFixed(2)
                : 0;
            const productivityPerEmployee = data.employees > 0
                ? (data.revenue / data.employees).toFixed(2)
                : 0;
            const conversionRate = data.leads > 0
                ? ((data.sales / data.leads) * 100).toFixed(2)
                : 0;
            const retentionRate = data.customers > 0
                ? ((data.returningCustomers / data.customers) * 100).toFixed(2)
                : 0;
            const burnRate = data.expenses > 0 && data.months > 0
                ? (data.expenses / data.months).toFixed(2)
                : 0;
            const revenueGrowth = data.previousRevenue > 0
                ? (((data.revenue - data.previousRevenue) / data.previousRevenue) * 100).toFixed(2)
                : 0;

            return {
                roiMarketing: parseFloat(roiMarketing),
                grossMargin: parseFloat(grossMargin),
                productivityPerEmployee: parseFloat(productivityPerEmployee),
                conversionRate: parseFloat(conversionRate),
                retentionRate: parseFloat(retentionRate),
                burnRate: parseFloat(burnRate),
                revenueGrowth: parseFloat(revenueGrowth)
            };
        };

        const analyzeKPIs = (kpis, ai) => {
            const insights = [];

            // ROI Marketing
            if (kpis.roiMarketing > 300) {
                insights.push({ severity: 'excellent', metric: 'ROI Marketing', value: `${kpis.roiMarketing}%`, message: 'ROI excepcional - campa√±as muy efectivas', recommendation: 'Escalar inversi√≥n en canales exitosos' });
            } else if (kpis.roiMarketing > 150) {
                insights.push({ severity: 'good', metric: 'ROI Marketing', value: `${kpis.roiMarketing}%`, message: 'ROI saludable - buena eficiencia', recommendation: 'Optimizar canales de menor rendimiento' });
            } else if (kpis.roiMarketing > 50) {
                insights.push({ severity: 'warning', metric: 'ROI Marketing', value: `${kpis.roiMarketing}%`, message: 'ROI bajo el est√°ndar', recommendation: 'Revisar estrategia y segmentaci√≥n' });
            } else {
                insights.push({ severity: 'critical', metric: 'ROI Marketing', value: `${kpis.roiMarketing}%`, message: 'ROI cr√≠tico - inversi√≥n ineficiente', recommendation: 'Reestructurar completamente la estrategia de marketing' });
            }

            // Gross Margin
            if (kpis.grossMargin > 60) {
                insights.push({ severity: 'excellent', metric: 'Margen Bruto', value: `${kpis.grossMargin}%`, message: 'Margen excelente - alta rentabilidad', recommendation: 'Mantener estructura de costos y considerar reinversi√≥n' });
            } else if (kpis.grossMargin > 40) {
                insights.push({ severity: 'good', metric: 'Margen Bruto', value: `${kpis.grossMargin}%`, message: 'Margen saludable', recommendation: 'Buscar eficiencias en costos de producci√≥n' });
            } else if (kpis.grossMargin > 20) {
                insights.push({ severity: 'warning', metric: 'Margen Bruto', value: `${kpis.grossMargin}%`, message: 'Margen ajustado', recommendation: 'Negociar con proveedores o ajustar precios' });
            } else {
                insights.push({ severity: 'critical', metric: 'Margen Bruto', value: `${kpis.grossMargin}%`, message: 'Margen cr√≠tico - riesgo de insostenibilidad', recommendation: 'Acci√≥n urgente: reducir costos o aumentar precios' });
            }

            // Retention Rate
            if (kpis.retentionRate > 80) {
                insights.push({ severity: 'excellent', metric: 'Tasa de Retenci√≥n', value: `${kpis.retentionRate}%`, message: 'Retenci√≥n excepcional - clientes muy satisfechos', recommendation: 'Implementar programa de referidos' });
            } else if (kpis.retentionRate > 60) {
                insights.push({ severity: 'good', metric: 'Tasa de Retenci√≥n', value: `${kpis.retentionRate}%`, message: 'Retenci√≥n buena', recommendation: 'Desarrollar programas de fidelizaci√≥n' });
            } else if (kpis.retentionRate > 40) {
                insights.push({ severity: 'warning', metric: 'Tasa de Retenci√≥n', value: `${kpis.retentionRate}%`, message: 'Retenci√≥n baja - clientes se van', recommendation: 'Investigar razones de abandono y mejorar servicio' });
            } else {
                insights.push({ severity: 'critical', metric: 'Tasa de Retenci√≥n', value: `${kpis.retentionRate}%`, message: 'Retenci√≥n cr√≠tica - problema serio de satisfacci√≥n', recommendation: 'Acci√≥n inmediata: encuestas, entrevistas y plan de recuperaci√≥n' });
            }

            // Conversion Rate
            if (kpis.conversionRate > 10) {
                insights.push({ severity: 'excellent', metric: 'Tasa de Conversi√≥n', value: `${kpis.conversionRate}%`, message: 'Conversi√≥n excepcional', recommendation: 'Documentar proceso y replicar en otros canales' });
            } else if (kpis.conversionRate > 5) {
                insights.push({ severity: 'good', metric: 'Tasa de Conversi√≥n', value: `${kpis.conversionRate}%`, message: 'Conversi√≥n saludable', recommendation: 'A/B testing para mejorar funnel' });
            } else if (kpis.conversionRate > 2) {
                insights.push({ severity: 'warning', metric: 'Tasa de Conversi√≥n', value: `${kpis.conversionRate}%`, message: 'Conversi√≥n baja', recommendation: 'Revisar proceso de ventas y calificaci√≥n de leads' });
            } else {
                insights.push({ severity: 'critical', metric: 'Tasa de Conversi√≥n', value: `${kpis.conversionRate}%`, message: 'Conversi√≥n cr√≠tica', recommendation: 'Reevaluar producto-mercado fit y propuesta de valor' });
            }

            // Revenue Growth
            if (kpis.revenueGrowth > 50) {
                insights.push({ severity: 'excellent', metric: 'Crecimiento Revenue', value: `${kpis.revenueGrowth}%`, message: 'Crecimiento explosivo', recommendation: 'Asegurar operaciones escalables' });
            } else if (kpis.revenueGrowth > 20) {
                insights.push({ severity: 'good', metric: 'Crecimiento Revenue', value: `${kpis.revenueGrowth}%`, message: 'Crecimiento s√≥lido', recommendation: 'Mantener momentum e invertir en adquisici√≥n' });
            } else if (kpis.revenueGrowth > 0) {
                insights.push({ severity: 'warning', metric: 'Crecimiento Revenue', value: `${kpis.revenueGrowth}%`, message: 'Crecimiento lento', recommendation: 'Acelerar estrategias de crecimiento' });
            } else {
                insights.push({ severity: 'critical', metric: 'Crecimiento Revenue', value: `${kpis.revenueGrowth}%`, message: 'Revenue en declive', recommendation: 'Revisi√≥n estrat√©gica urgente' });
            }

            return insights;
        };

        // ============================================
        // PROJECTS MODULE - UI COMPONENTS
        // ============================================

        // Loop Detection Badge
        function LoopDetectionBadge({ loops }) {
            if (!loops || loops.length === 0) return null;

            const worstLoop = loops.reduce((worst, current) => {
                if (current.severity === 'error') return current;
                if (worst.severity === 'error') return worst;
                if (current.severity === 'warning') return current;
                return worst;
            }, loops[0]);

            return (
                <div className={`loop-badge inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${
                    worstLoop.severity === 'error' ? 'bg-red-100 text-red-800 border-red-300' : ''
                }`}>
                    ‚ö†Ô∏è {worstLoop.message}
                </div>
            );
        }

        // Suggestion Badge
        function SuggestionBadge({ specialist }) {
            if (!specialist) return null;
            const ai = AISpecialists.find(s => s.id === specialist);
            return (
                <div className="suggestion-badge inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold">
                    üí° Sugerido: {ai?.name}
                </div>
            );
        }

        // ============================================
        // DEMO DATA INITIALIZATION
        // ============================================
        const initializeDemoData = () => {
            // Solo inicializar si no hay datos previos
            const hasExistingData = StorageOps.loadAllProjects().length > 0 || StorageOps.loadAllKPIReports().length > 0 || StorageOps.loadAllEVStations().length > 0;
            if (hasExistingData) {
                console.log('üì¶ Data existente detectada - skip demo data');
                return;
            }

            console.log('üé¨ Inicializando DEMO DATA UNIVERSAL...');

            // ========== DEMO PROJECTS ==========
            const demoProjects = [
                {
                    id: 'proyecto-demo-1',
                    name: 'Transformaci√≥n Digital 2024',
                    createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), // 15 d√≠as atr√°s
                    tasks: [
                        {
                            id: 1701234567890,
                            name: 'An√°lisis de infraestructura actual',
                            status: 'completed',
                            assignedAI: 'gemini',
                            progress: 100,
                            notes: 'Auditoria completa de sistemas legacy y cloud readiness',
                            createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), event: 'completed', details: 'An√°lisis completado', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567891,
                            name: 'Migraci√≥n base de datos a AWS RDS',
                            status: 'active',
                            assignedAI: 'deepseek',
                            progress: 65,
                            notes: 'PostgreSQL 14 -> AWS RDS. Replicaci√≥n configurada, testing en progreso',
                            createdAt: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(), event: 'status_change', details: 'Cambio pending -> active', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567892,
                            name: 'Implementar CI/CD con GitHub Actions',
                            status: 'active',
                            assignedAI: 'gpt4',
                            progress: 45,
                            notes: 'Pipeline configurado para dev y staging. Producci√≥n pendiente',
                            createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567893,
                            name: 'Capacitaci√≥n equipo en nuevas herramientas',
                            status: 'pending',
                            assignedAI: 'claude',
                            progress: 0,
                            notes: 'Plan de capacitaci√≥n: Docker, K8s, AWS. 3 sesiones de 4 horas',
                            createdAt: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567894,
                            name: 'Configurar monitoreo con DataDog',
                            status: 'pending',
                            assignedAI: 'gemini',
                            progress: 0,
                            notes: 'Dashboards, alertas y m√©tricas cr√≠ticas',
                            createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567895,
                            name: 'Documentaci√≥n arquitectura cloud',
                            status: 'blocked',
                            assignedAI: 'claude',
                            progress: 20,
                            notes: 'Bloqueado: esperando aprobaci√≥n de seguridad para diagramas',
                            createdAt: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), event: 'blocked', details: 'Bloqueado por compliance', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567896,
                            name: 'Testing de carga y performance',
                            status: 'pending',
                            assignedAI: 'deepseek',
                            progress: 0,
                            notes: 'Simular 10K usuarios concurrentes',
                            createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        }
                    ]
                },
                {
                    id: 'proyecto-demo-2',
                    name: 'Optimizaci√≥n Procesos RH',
                    createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
                    tasks: [
                        {
                            id: 1701234567900,
                            name: 'Mapeo procesos actuales de onboarding',
                            status: 'completed',
                            assignedAI: 'claude',
                            progress: 100,
                            notes: 'Identificados 12 pasos manuales automatizables',
                            createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), event: 'completed', details: 'Mapeo completado', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567901,
                            name: 'Implementar firma digital de contratos',
                            status: 'active',
                            assignedAI: 'gpt4',
                            progress: 75,
                            notes: 'Integraci√≥n con DocuSign. Testing final en curso',
                            createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567902,
                            name: 'Chatbot para consultas de n√≥mina',
                            status: 'active',
                            assignedAI: 'claude',
                            progress: 40,
                            notes: 'Bot entrenado con 500+ preguntas frecuentes',
                            createdAt: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567903,
                            name: 'Dashboard analytics de RRHH',
                            status: 'pending',
                            assignedAI: 'gemini',
                            progress: 0,
                            notes: 'M√©tricas: rotaci√≥n, satisfacci√≥n, time-to-hire',
                            createdAt: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567904,
                            name: 'Capacitaci√≥n en nuevas plataformas',
                            status: 'completed',
                            assignedAI: 'claude',
                            progress: 100,
                            notes: 'Sesiones realizadas: 3 workshops de 2 horas',
                            createdAt: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(), event: 'completed', details: 'Capacitaciones finalizadas', user: 'Sistema' }
                            ]
                        }
                    ]
                },
                {
                    id: 'proyecto-demo-3',
                    name: 'Expansi√≥n Regi√≥n Sur',
                    createdAt: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
                    tasks: [
                        {
                            id: 1701234567910,
                            name: 'Estudio de mercado Regi√≥n Metropolitana Sur',
                            status: 'completed',
                            assignedAI: 'gemini',
                            progress: 100,
                            notes: 'An√°lisis demogr√°fico y competencia completado',
                            createdAt: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString(), event: 'completed', details: 'Estudio finalizado', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567911,
                            name: 'Negociaci√≥n arriendo locales comerciales',
                            status: 'active',
                            assignedAI: 'gpt4',
                            progress: 60,
                            notes: '3 locales identificados. Negociando con 2 propietarios',
                            createdAt: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567912,
                            name: 'Reclutamiento personal para nuevas sucursales',
                            status: 'active',
                            assignedAI: 'claude',
                            progress: 35,
                            notes: 'Necesarios: 12 vendedores, 3 supervisores, 2 gerentes',
                            createdAt: new Date(Date.now() - 16 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 16 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567913,
                            name: 'Dise√±o layout y ambientaci√≥n locales',
                            status: 'pending',
                            assignedAI: 'gemini',
                            progress: 0,
                            notes: 'Pendiente confirmaci√≥n de locales',
                            createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567914,
                            name: 'Plan de marketing apertura',
                            status: 'blocked',
                            assignedAI: 'gpt4',
                            progress: 15,
                            notes: 'Bloqueado: esperando presupuesto de Marketing',
                            createdAt: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' },
                                { timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), event: 'blocked', details: 'Esperando presupuesto', user: 'Sistema' }
                            ]
                        },
                        {
                            id: 1701234567915,
                            name: 'Setup sistemas POS y CRM',
                            status: 'pending',
                            assignedAI: 'deepseek',
                            progress: 0,
                            notes: 'Infraestructura IT para 3 nuevos puntos de venta',
                            createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                            lastModified: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                            history: [
                                { timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), event: 'created', details: 'Tarea creada', user: 'Sistema' }
                            ]
                        }
                    ]
                }
            ];

            // Guardar proyectos demo
            demoProjects.forEach(project => {
                StorageOps.saveProject(project);
            });

            // ========== DEMO KPI REPORTS ==========
            const demoKPIReports = [
                {
                    id: 'kpi-demo-1',
                    companyName: 'TechCorp Solutions',
                    departmentName: 'Divisi√≥n Cloud Services',
                    period: 'Q3 2024',
                    revenue: 2500000,
                    previousRevenue: 1800000,
                    costOfSales: 800000,
                    marketingInvestment: 300000,
                    employees: 45,
                    leads: 850,
                    sales: 120,
                    customers: 180,
                    returningCustomers: 155,
                    expenses: 450000,
                    months: 3,
                    kpiResults: {
                        roiMarketing: 566.67,
                        grossMargin: 68.00,
                        productivityPerEmployee: 55555.56,
                        conversionRate: 14.12,
                        retentionRate: 86.11,
                        burnRate: 150000.00,
                        revenueGrowth: 38.89
                    },
                    insights: [
                        { severity: 'excellent', metric: 'ROI Marketing', value: '566.67%', message: 'ROI excepcional - campa√±as muy efectivas', recommendation: 'Escalar inversi√≥n en canales exitosos' },
                        { severity: 'excellent', metric: 'Margen Bruto', value: '68.00%', message: 'Margen excelente - alta rentabilidad', recommendation: 'Mantener estructura de costos y considerar reinversi√≥n' },
                        { severity: 'excellent', metric: 'Tasa de Retenci√≥n', value: '86.11%', message: 'Retenci√≥n excepcional - clientes muy satisfechos', recommendation: 'Implementar programa de referidos' },
                        { severity: 'excellent', metric: 'Tasa de Conversi√≥n', value: '14.12%', message: 'Conversi√≥n excepcional', recommendation: 'Documentar proceso y replicar en otros canales' },
                        { severity: 'good', metric: 'Crecimiento Revenue', value: '38.89%', message: 'Crecimiento s√≥lido', recommendation: 'Mantener momentum e invertir en adquisici√≥n' }
                    ],
                    assignedAI: 'claude',
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'kpi-demo-2',
                    companyName: 'RetailMax',
                    departmentName: 'Operaciones Regionales',
                    period: 'Q2 2024',
                    revenue: 1200000,
                    previousRevenue: 1150000,
                    costOfSales: 720000,
                    marketingInvestment: 180000,
                    employees: 85,
                    leads: 2400,
                    sales: 95,
                    customers: 450,
                    returningCustomers: 270,
                    expenses: 380000,
                    months: 3,
                    kpiResults: {
                        roiMarketing: 266.67,
                        grossMargin: 40.00,
                        productivityPerEmployee: 14117.65,
                        conversionRate: 3.96,
                        retentionRate: 60.00,
                        burnRate: 126666.67,
                        revenueGrowth: 4.35
                    },
                    insights: [
                        { severity: 'good', metric: 'ROI Marketing', value: '266.67%', message: 'ROI saludable - buena eficiencia', recommendation: 'Optimizar canales de menor rendimiento' },
                        { severity: 'good', metric: 'Margen Bruto', value: '40.00%', message: 'Margen saludable', recommendation: 'Buscar eficiencias en costos de producci√≥n' },
                        { severity: 'good', metric: 'Tasa de Retenci√≥n', value: '60.00%', message: 'Retenci√≥n buena', recommendation: 'Desarrollar programas de fidelizaci√≥n' },
                        { severity: 'warning', metric: 'Tasa de Conversi√≥n', value: '3.96%', message: 'Conversi√≥n baja', recommendation: 'Revisar proceso de ventas y calificaci√≥n de leads' },
                        { severity: 'warning', metric: 'Crecimiento Revenue', value: '4.35%', message: 'Crecimiento lento', recommendation: 'Acelerar estrategias de crecimiento' }
                    ],
                    assignedAI: 'gemini',
                    createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'kpi-demo-3',
                    companyName: 'StartupXYZ',
                    departmentName: 'Growth Team',
                    period: 'Q3 2024',
                    revenue: 850000,
                    previousRevenue: 420000,
                    costOfSales: 340000,
                    marketingInvestment: 220000,
                    employees: 22,
                    leads: 1850,
                    sales: 145,
                    customers: 95,
                    returningCustomers: 55,
                    expenses: 520000,
                    months: 3,
                    kpiResults: {
                        roiMarketing: 286.36,
                        grossMargin: 60.00,
                        productivityPerEmployee: 38636.36,
                        conversionRate: 7.84,
                        retentionRate: 57.89,
                        burnRate: 173333.33,
                        revenueGrowth: 102.38
                    },
                    insights: [
                        { severity: 'good', metric: 'ROI Marketing', value: '286.36%', message: 'ROI saludable - buena eficiencia', recommendation: 'Optimizar canales de menor rendimiento' },
                        { severity: 'excellent', metric: 'Margen Bruto', value: '60.00%', message: 'Margen excelente - alta rentabilidad', recommendation: 'Mantener estructura de costos y considerar reinversi√≥n' },
                        { severity: 'warning', metric: 'Tasa de Retenci√≥n', value: '57.89%', message: 'Retenci√≥n baja - clientes se van', recommendation: 'Investigar razones de abandono y mejorar servicio' },
                        { severity: 'good', metric: 'Tasa de Conversi√≥n', value: '7.84%', message: 'Conversi√≥n saludable', recommendation: 'A/B testing para mejorar funnel' },
                        { severity: 'excellent', metric: 'Crecimiento Revenue', value: '102.38%', message: 'Crecimiento explosivo', recommendation: 'Asegurar operaciones escalables' }
                    ],
                    assignedAI: 'deepseek',
                    createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];

            // Guardar reportes KPI demo
            demoKPIReports.forEach(report => {
                StorageOps.saveKPIReport(report);
            });

            // ========== DEMO EV OPS (Santiago 20) ==========
            // Nota: Datos SIMULADOS para demo ejecutiva (sin datos sensibles)
            const demoEVStations = [
                {
                    id: 'ev-scl-01',
                    name: 'Red EV - SCL 01',
                    provider: 'Operador EV',
                    comuna: 'Las Condes',
                    address: 'Punto 01, Las Condes, Santiago',
                    lat: -33.404654,
                    lng: -70.58125,
                    powerKW: 50,
                    connectors: ['CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 37 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-02',
                    name: 'Red EV - SCL 02',
                    provider: 'Operador EV',
                    comuna: 'Providencia',
                    address: 'Punto 02, Providencia, Santiago',
                    lat: -33.427325,
                    lng: -70.610699,
                    powerKW: 150,
                    connectors: ['Type2', 'CCS2'],
                    status: 'offline',
                    occupancy: 2,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 2 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-03',
                    name: 'Red EV - SCL 03',
                    provider: 'Operador EV',
                    comuna: 'Santiago Centro',
                    address: 'Punto 03, Santiago Centro, Santiago',
                    lat: -33.448237,
                    lng: -70.663189,
                    powerKW: 150,
                    connectors: ['Type2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 45 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-04',
                    name: 'Red EV - SCL 04',
                    provider: 'Operador EV',
                    comuna: '√ëu√±oa',
                    address: 'Punto 04, √ëu√±oa, Santiago',
                    lat: -33.45453,
                    lng: -70.591519,
                    powerKW: 50,
                    connectors: ['Type2', 'CCS2'],
                    status: 'occupied',
                    occupancy: 86,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 9 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-05',
                    name: 'Red EV - SCL 05',
                    provider: 'Operador EV',
                    comuna: 'La Reina',
                    address: 'Punto 05, La Reina, Santiago',
                    lat: -33.440858,
                    lng: -70.531717,
                    powerKW: 50,
                    connectors: ['Type2', 'CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 45 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-06',
                    name: 'Red EV - SCL 06',
                    provider: 'Operador EV',
                    comuna: 'Maip√∫',
                    address: 'Punto 06, Maip√∫, Santiago',
                    lat: -33.512834,
                    lng: -70.766336,
                    powerKW: 22,
                    connectors: ['Type2', 'CCS2'],
                    status: 'queue',
                    occupancy: 10,
                    queue: 1,
                    lastUpdate: new Date(Date.now() - 36 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-07',
                    name: 'Red EV - SCL 07',
                    provider: 'Operador EV',
                    comuna: 'Puente Alto',
                    address: 'Punto 07, Puente Alto, Santiago',
                    lat: -33.620679,
                    lng: -70.564575,
                    powerKW: 100,
                    connectors: ['Type2'],
                    status: 'occupied',
                    occupancy: 62,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 19 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-08',
                    name: 'Red EV - SCL 08',
                    provider: 'Operador EV',
                    comuna: 'La Florida',
                    address: 'Punto 08, La Florida, Santiago',
                    lat: -33.538645,
                    lng: -70.573644,
                    powerKW: 150,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'occupied',
                    occupancy: 100,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 43 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-09',
                    name: 'Red EV - SCL 09',
                    provider: 'Operador EV',
                    comuna: 'Estaci√≥n Central',
                    address: 'Punto 09, Estaci√≥n Central, Santiago',
                    lat: -33.458144,
                    lng: -70.693863,
                    powerKW: 50,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 23 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-10',
                    name: 'Red EV - SCL 10',
                    provider: 'Operador EV',
                    comuna: 'Quilicura',
                    address: 'Punto 10, Quilicura, Santiago',
                    lat: -33.343355,
                    lng: -70.70934,
                    powerKW: 60,
                    connectors: ['Type2', 'CCS2'],
                    status: 'offline',
                    occupancy: 12,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 9 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-11',
                    name: 'Red EV - SCL 11',
                    provider: 'Operador EV',
                    comuna: 'Las Condes',
                    address: 'Punto 11, Las Condes, Santiago',
                    lat: -33.404744,
                    lng: -70.571055,
                    powerKW: 50,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 20 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-12',
                    name: 'Red EV - SCL 12',
                    provider: 'Operador EV',
                    comuna: 'Providencia',
                    address: 'Punto 12, Providencia, Santiago',
                    lat: -33.428156,
                    lng: -70.610494,
                    powerKW: 50,
                    connectors: ['CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 29 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-13',
                    name: 'Red EV - SCL 13',
                    provider: 'Operador EV',
                    comuna: 'Santiago Centro',
                    address: 'Punto 13, Santiago Centro, Santiago',
                    lat: -33.445078,
                    lng: -70.654616,
                    powerKW: 50,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'queue',
                    occupancy: 20,
                    queue: 5,
                    lastUpdate: new Date(Date.now() - 12 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-14',
                    name: 'Red EV - SCL 14',
                    provider: 'Operador EV',
                    comuna: '√ëu√±oa',
                    address: 'Punto 14, √ëu√±oa, Santiago',
                    lat: -33.447772,
                    lng: -70.58972,
                    powerKW: 22,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 31 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-15',
                    name: 'Red EV - SCL 15',
                    provider: 'Operador EV',
                    comuna: 'La Reina',
                    address: 'Punto 15, La Reina, Santiago',
                    lat: -33.445372,
                    lng: -70.554014,
                    powerKW: 50,
                    connectors: ['Type2', 'CCS2'],
                    status: 'queue',
                    occupancy: 18,
                    queue: 3,
                    lastUpdate: new Date(Date.now() - 2 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-16',
                    name: 'Red EV - SCL 16',
                    provider: 'Operador EV',
                    comuna: 'Maip√∫',
                    address: 'Punto 16, Maip√∫, Santiago',
                    lat: -33.511505,
                    lng: -70.743564,
                    powerKW: 50,
                    connectors: ['CCS2'],
                    status: 'occupied',
                    occupancy: 76,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 18 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-17',
                    name: 'Red EV - SCL 17',
                    provider: 'Operador EV',
                    comuna: 'Puente Alto',
                    address: 'Punto 17, Puente Alto, Santiago',
                    lat: -33.60512,
                    lng: -70.573831,
                    powerKW: 150,
                    connectors: ['Type2', 'CCS2'],
                    status: 'occupied',
                    occupancy: 87,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 34 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-18',
                    name: 'Red EV - SCL 18',
                    provider: 'Operador EV',
                    comuna: 'La Florida',
                    address: 'Punto 18, La Florida, Santiago',
                    lat: -33.553312,
                    lng: -70.55508,
                    powerKW: 100,
                    connectors: ['Type2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 13 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-19',
                    name: 'Red EV - SCL 19',
                    provider: 'Operador EV',
                    comuna: 'Estaci√≥n Central',
                    address: 'Punto 19, Estaci√≥n Central, Santiago',
                    lat: -33.453861,
                    lng: -70.689167,
                    powerKW: 50,
                    connectors: ['Type2', 'CCS2'],
                    status: 'available',
                    occupancy: 0,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 34 * 60 * 1000).toISOString()
                },
                {
                    id: 'ev-scl-20',
                    name: 'Red EV - SCL 20',
                    provider: 'Operador EV',
                    comuna: 'Quilicura',
                    address: 'Punto 20, Quilicura, Santiago',
                    lat: -33.352686,
                    lng: -70.723457,
                    powerKW: 150,
                    connectors: ['CHAdeMO', 'CCS2'],
                    status: 'occupied',
                    occupancy: 89,
                    queue: 0,
                    lastUpdate: new Date(Date.now() - 8 * 60 * 1000).toISOString()
                }
            ];

            // Guardar estaciones EV demo
            demoEVStations.forEach(st => {
                StorageOps.saveEVStation({
                    ...st,
                    source: 'SIMULATED',
                    updatedBy: 'Sistema'
                });
            });


            console.log('‚úÖ DEMO DATA CARGADA:', {
                proyectos: demoProjects.length,
                reportesKPI: demoKPIReports.length,
                estacionesEV: demoEVStations.length,
                totalTareas: demoProjects.reduce((sum, p) => sum + p.tasks.length, 0)
            });
        };

        // Ejecutar inicializaci√≥n al cargar
        if (typeof window !== 'undefined') {
            initializeDemoData();
        }

        // Task Card Component
        function TaskCard({ task, onEdit, onChangeStatus, onChangeAI, onDelete }) {
            const [showDetails, setShowDetails] = useState(false);
            const specialist = AISpecialists.find(s => s.id === task.assignedAI);
            const availableTransitions = StateTransitions[task.status] || [];
            const loops = detectLoops(task);
            
            return (
                <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 hover:border-purple-500 transition task-card">
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                                <h3 className="text-lg font-bold text-white">{task.name}</h3>
                                <span className={`state-badge state-${task.status}`}>
                                    {task.status}
                                </span>
                            </div>
                            <div className="flex items-center gap-2 text-sm text-gray-400">
                                <span className={`ai-badge ai-${task.assignedAI}`}>
                                    {specialist?.name}
                                </span>
                                <span>‚Ä¢</span>
                                <span>{getTimeAgo(task.lastModified)}</span>
                                <span>‚Ä¢</span>
                                <span>{task.progress}% completado</span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowDetails(!showDetails)} className="text-gray-400 hover:text-white">
                                {showDetails ? '‚ñ≤' : '‚ñº'}
                            </button>
                            <button onClick={() => onDelete(task.id)} className="text-red-400 hover:text-red-300">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    {loops.length > 0 && (
                        <div className="mb-3">
                            <LoopDetectionBadge loops={loops} />
                        </div>
                    )}

                    {/* Progress Bar */}
                    <div className="mb-4">
                        <div className="w-full bg-gray-700 rounded-full h-2">
                            <div 
                                className="bg-gradient-to-r from-purple-600 to-purple-800 h-2 rounded-full transition-all duration-500"
                                style={{ width: `${task.progress}%` }}
                            ></div>
                        </div>
                    </div>

                    {showDetails && (
                        <div className="space-y-4 animate-slide-in">
                            {task.notes && (
                                <div className="bg-gray-700 rounded p-3">
                                    <p className="text-sm text-gray-300">{task.notes}</p>
                                </div>
                            )}

                            {/* Actions */}
                            <div className="flex flex-wrap gap-2">
                                <select
                                    value={task.assignedAI}
                                    onChange={(e) => onChangeAI(task.id, e.target.value)}
                                    className="px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 text-sm"
                                >
                                    {AISpecialists.map(ai => (
                                        <option key={ai.id} value={ai.id}>{ai.name} - {ai.role}</option>
                                    ))}
                                </select>

                                {availableTransitions.map(newStatus => (
                                    <button
                                        key={newStatus}
                                        onClick={() => onChangeStatus(task.id, newStatus)}
                                        className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-sm font-semibold"
                                    >
                                        ‚Üí {newStatus}
                                    </button>
                                ))}

                                <button
                                    onClick={() => onEdit(task)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>

                            {/* History */}
                            {task.history && task.history.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="text-sm font-semibold text-gray-400 mb-2">üìú Historial</h4>
                                    <div className="space-y-2 max-h-40 overflow-y-auto">
                                        {task.history.slice().reverse().map((entry, idx) => (
                                            <div key={idx} className="history-entry text-xs text-gray-500 border-l-2 border-gray-600 pl-3">
                                                <span className="font-semibold">{entry.event}</span> - {entry.details}
                                                <br />
                                                <span className="text-gray-600">{formatDateTime(entry.timestamp)} por {entry.user}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Analytics Dashboard Component
        function AnalyticsDashboard({ project }) {
            const analytics = calculateAnalytics(project);

            if (!project || !project.tasks || project.tasks.length === 0) {
                return (
                    <div className="bg-gray-800 rounded-lg p-8 border border-gray-700 text-center">
                        <div className="text-4xl mb-4">üìä</div>
                        <p className="text-gray-400">No hay datos suficientes para an√°lisis</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* Synaptic Score */}
                    <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg p-8 border border-blue-700 text-center">
                        <h2 className="text-xl font-bold text-white mb-4">Synaptic Score</h2>
                        <div className="synaptic-score mb-2">{analytics.synapsisScore}</div>
                        <p className="text-blue-200 text-sm">
                            M√©trica de efectividad del Protocolo Sinapsis
                        </p>
                    </div>

                    {/* Key Metrics */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700 text-center">
                            <div className="text-3xl font-bold text-white mb-2">{analytics.totalTasks}</div>
                            <div className="text-sm text-gray-400">Total Tareas</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-6 border border-green-700 text-center">
                            <div className="text-3xl font-bold text-green-400 mb-2">{analytics.completedTasks}</div>
                            <div className="text-sm text-gray-400">Completadas</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-6 border border-blue-700 text-center">
                            <div className="text-3xl font-bold text-blue-400 mb-2">{analytics.activeTasks}</div>
                            <div className="text-sm text-gray-400">Activas</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-6 border border-red-700 text-center">
                            <div className="text-3xl font-bold text-red-400 mb-2">{analytics.blockedTasks}</div>
                            <div className="text-sm text-gray-400">Bloqueadas</div>
                        </div>
                    </div>

                    {/* Specialist Usage Chart */}
                    <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 className="text-lg font-bold text-white mb-4">Uso de Especialistas</h3>
                        <div className="space-y-3">
                            {Object.entries(analytics.specialistUsage).map(([specialist, count]) => {
                                const percentage = analytics.totalTasks > 0 ? (count / analytics.totalTasks) * 100 : 0;
                                const ai = AISpecialists.find(s => s.id === specialist);
                                return (
                                    <div key={specialist}>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-gray-300">{ai?.name}</span>
                                            <span className="text-gray-400">{count} tareas ({percentage.toFixed(0)}%)</span>
                                        </div>
                                        <div className="w-full bg-gray-700 rounded-full h-3">
                                            <div 
                                                className={`chart-bar h-3 rounded-full ai-${specialist}`}
                                                style={{ width: `${percentage}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Insights */}
                    <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 className="text-lg font-bold text-white mb-4">üîç Insights</h3>
                        <div className="space-y-2">
                            {analytics.insights.map((insight, idx) => (
                                <div key={idx} className={`p-3 rounded border-l-4 ${
                                    insight.type === 'success' ? 'bg-green-900 border-green-500' :
                                    insight.type === 'error' ? 'bg-red-900 border-red-500' :
                                    insight.type === 'warning' ? 'bg-yellow-900 border-yellow-500' :
                                    'bg-blue-900 border-blue-500'
                                }`}>
                                    <p className="text-sm text-white">{insight.text}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Cross-Pollination Stats */}
                    {analytics.crossPollinationCount > 0 && (
                        <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg p-6 border border-blue-700">
                            <h3 className="text-lg font-bold text-white mb-2">üîÑ Cross-Pollination</h3>
                            <p className="text-blue-200 text-sm mb-3">
                                {analytics.crossPollinationCount} cambios de especialista detectados
                            </p>
                            <p className="text-blue-300 text-xs">
                                La metodolog√≠a de cross-pollination permite superar l√≠mites cognitivos al cambiar de especialista cuando es necesario.
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        // Shortcuts Modal Component
        function ShortcutsModal({ onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 shortcuts-modal" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 border border-purple-500" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">‚å®Ô∏è Atajos de Teclado</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">√ó</button>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gray-700 rounded p-4">
                                <div className="font-mono text-purple-400 mb-2">N</div>
                                <div className="text-sm text-gray-300">Nueva Tarea</div>
                            </div>
                            <div className="bg-gray-700 rounded p-4">
                                <div className="font-mono text-purple-400 mb-2">A</div>
                                <div className="text-sm text-gray-300">Analytics</div>
                            </div>
                            <div className="bg-gray-700 rounded p-4">
                                <div className="font-mono text-purple-400 mb-2">E</div>
                                <div className="text-sm text-gray-300">Exportar Proyecto</div>
                            </div>
                            <div className="bg-gray-700 rounded p-4">
                                <div className="font-mono text-purple-400 mb-2">?</div>
                                <div className="text-sm text-gray-300">Ver Atajos</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // HOME MODULE - DASHBOARD CONSOLIDADO
        // ============================================
        function HomeModule() {
            const [projects, setProjects] = useState([]);
            const [kpiReports, setKpiReports] = useState([]);

            useEffect(() => {
                const loadAll = () => {
                    const loadedProjects = StorageOps.loadAllProjects();
                    const loadedKPIs = StorageOps.loadAllKPIReports();
                    setProjects(loadedProjects);
                    setKpiReports(loadedKPIs);
                };
                loadAll();
                const onUpd = () => loadAll();
                window.addEventListener('sinapsis:projectsUpdated', onUpd);
                return () => window.removeEventListener('sinapsis:projectsUpdated', onUpd);
            }, []);

            // Calcular m√©tricas agregadas globales
            const globalMetrics = React.useMemo(() => {
                const totalProjects = projects.length;
                const totalKPIReports = kpiReports.length;
                
                // M√©tricas de tareas
                let allTasks = [];
                projects.forEach(project => {
                    if (project.tasks) {
                        allTasks = [...allTasks, ...project.tasks];
                    }
                });

                const totalTasks = allTasks.length;
                const completedTasks = allTasks.filter(t => t.status === 'completed').length;
                const activeTasks = allTasks.filter(t => t.status === 'active').length;
                const pendingTasks = allTasks.filter(t => t.status === 'pending').length;
                const blockedTasks = allTasks.filter(t => t.status === 'blocked').length;

                // Distribuci√≥n por especialista
                const aiDistribution = {
                    gemini: allTasks.filter(t => t.assignedAI === 'gemini').length,
                    gpt4: allTasks.filter(t => t.assignedAI === 'gpt4').length,
                    claude: allTasks.filter(t => t.assignedAI === 'claude').length,
                    deepseek: allTasks.filter(t => t.assignedAI === 'deepseek').length
                };

                // Loops y sugerencias (las sugerencias est√°n dentro de los loops)
                let totalLoops = 0;
                let totalSuggestions = 0;
                allTasks.forEach(task => {
                    const loops = detectLoops(task);
                    totalLoops += loops.length;
                    totalSuggestions += loops.length; // Cada loop tiene una sugerencia
                });

                // Synaptic Score del portfolio (promedio ponderado)
                let totalScore = 0;
                let totalWeight = 0;
                projects.forEach(project => {
                    const analytics = calculateAnalytics(project);
                    const weight = project.tasks?.length || 1;
                    totalScore += analytics.synapsisScore * weight;
                    totalWeight += weight;
                });
                const portfolioScore = totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0;

                // Completion rate
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                return {
                    totalProjects,
                    totalKPIReports,
                    totalTasks,
                    completedTasks,
                    activeTasks,
                    pendingTasks,
                    blockedTasks,
                    aiDistribution,
                    totalLoops,
                    totalSuggestions,
                    portfolioScore,
                    completionRate
                };
            }, [projects, kpiReports]);

            // Proyectos recientes (√∫ltimos 6)
            const recentProjects = React.useMemo(() => {
                return [...projects]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 6);
            }, [projects]);

            return (
                <div>
                    <div className="mb-8">
                        <h2 className="text-3xl font-bold text-white mb-2">üè† Dashboard Home</h2>
                        <p className="text-gray-400">Vista consolidada de todo el portfolio</p>
                    </div>

                    {/* Synaptic Score del Portfolio - Destacado */}
                    <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg p-8 border-2 border-blue-500 mb-8 text-center">
                        <div className="text-sm font-semibold text-blue-200 mb-2">PORTFOLIO SYNAPTIC SCORE</div>
                        <div className="synaptic-score text-7xl mb-2">{globalMetrics.portfolioScore}</div>
                        <div className="text-gray-300">
                            Promedio ponderado de {globalMetrics.totalProjects} proyecto{globalMetrics.totalProjects !== 1 ? 's' : ''}
                        </div>
                    </div>

                    {/* M√©tricas Globales */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="text-4xl mb-2">üéØ</div>
                            <div className="text-3xl font-bold text-white mb-1">{globalMetrics.totalProjects}</div>
                            <div className="text-sm text-gray-400">Proyectos Activos</div>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="text-4xl mb-2">‚úì</div>
                            <div className="text-3xl font-bold text-green-400 mb-1">{globalMetrics.completedTasks}</div>
                            <div className="text-sm text-gray-400">Tareas Completadas</div>
                            <div className="text-xs text-gray-500 mt-1">de {globalMetrics.totalTasks} totales</div>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="text-4xl mb-2">‚ö°</div>
                            <div className="text-3xl font-bold text-blue-400 mb-1">{globalMetrics.activeTasks}</div>
                            <div className="text-sm text-gray-400">Tareas Activas</div>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="text-4xl mb-2">üìä</div>
                            <div className="text-3xl font-bold text-blue-400 mb-1">{globalMetrics.completionRate}%</div>
                            <div className="text-sm text-gray-400">Tasa de Completitud</div>
                        </div>
                    </div>

                    {/* Distribuci√≥n por Estado y Especialista */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        {/* Distribuci√≥n por Estado */}
                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <h3 className="text-xl font-bold text-white mb-4">üìà Distribuci√≥n por Estado</h3>
                            <div className="space-y-3">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">üîµ Activas</span>
                                        <span className="text-white font-semibold">{globalMetrics.activeTasks}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-blue-500 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.activeTasks / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">‚è∏Ô∏è Pendientes</span>
                                        <span className="text-white font-semibold">{globalMetrics.pendingTasks}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-yellow-500 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.pendingTasks / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">‚úÖ Completadas</span>
                                        <span className="text-white font-semibold">{globalMetrics.completedTasks}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-green-500 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.completedTasks / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">üö´ Bloqueadas</span>
                                        <span className="text-white font-semibold">{globalMetrics.blockedTasks}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-red-500 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.blockedTasks / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Distribuci√≥n por Especialista */}
                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <h3 className="text-xl font-bold text-white mb-4">ü§ñ Distribuci√≥n por Especialista IA</h3>
                            <div className="space-y-3">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">
                                            <span className="ai-badge ai-gemini">Gemini</span>
                                        </span>
                                        <span className="text-white font-semibold">{globalMetrics.aiDistribution.gemini}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-purple-400 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.aiDistribution.gemini / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">
                                            <span className="ai-badge ai-gpt4">GPT-4</span>
                                        </span>
                                        <span className="text-white font-semibold">{globalMetrics.aiDistribution.gpt4}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-indigo-400 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.aiDistribution.gpt4 / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">
                                            <span className="ai-badge ai-claude">Claude</span>
                                        </span>
                                        <span className="text-white font-semibold">{globalMetrics.aiDistribution.claude}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-red-400 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.aiDistribution.claude / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">
                                            <span className="ai-badge ai-deepseek">DeepSeek</span>
                                        </span>
                                        <span className="text-white font-semibold">{globalMetrics.aiDistribution.deepseek}</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-3">
                                        <div 
                                            className="bg-green-400 h-3 rounded-full chart-bar" 
                                            style={{width: `${globalMetrics.totalTasks > 0 ? (globalMetrics.aiDistribution.deepseek / globalMetrics.totalTasks) * 100 : 0}%`}}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Inteligencia del Sistema */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white mb-2">üîÑ Loops Detectados</h3>
                                    <div className="text-4xl font-bold text-yellow-400">{globalMetrics.totalLoops}</div>
                                    <p className="text-sm text-gray-400 mt-2">Patrones cognitivos identificados</p>
                                </div>
                                <div className="text-6xl opacity-20">üîÑ</div>
                            </div>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white mb-2">üí° Sugerencias Inteligentes</h3>
                                    <div className="text-4xl font-bold text-blue-400">{globalMetrics.totalSuggestions}</div>
                                    <p className="text-sm text-gray-400 mt-2">Recomendaciones generadas</p>
                                </div>
                                <div className="text-6xl opacity-20">üí°</div>
                            </div>
                        </div>
                    </div>

                    {/* KPI Analytics */}
                    <div className="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">üìä An√°lisis KPI Realizados</h3>
                                <div className="text-4xl font-bold text-blue-400">{globalMetrics.totalKPIReports}</div>
                                <p className="text-sm text-gray-400 mt-2">Reportes de KPI generados</p>
                            </div>
                            <div className="text-6xl opacity-20">üìä</div>
                        </div>
                    </div>

                    {/* Proyectos Recientes */}
                    {recentProjects.length > 0 && (
                        <div>
                            <h3 className="text-2xl font-bold text-white mb-4">üìÇ Proyectos Recientes</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {recentProjects.map(project => {
                                    const analytics = calculateAnalytics(project);
                                    return (
                                        <div key={project.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500 transition">
                                            <h4 className="text-lg font-bold text-white mb-2">{project.name}</h4>
                                            <div className="grid grid-cols-3 gap-2 mb-3">
                                                <div className="text-center">
                                                    <div className="text-xs text-gray-400">Tareas</div>
                                                    <div className="text-sm font-bold text-white">{analytics.totalTasks}</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-xs text-gray-400">Completadas</div>
                                                    <div className="text-sm font-bold text-green-400">{analytics.completedTasks}</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-xs text-gray-400">Score</div>
                                                    <div className="text-sm font-bold text-blue-400">{analytics.synapsisScore}</div>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-500">{getTimeAgo(project.createdAt)}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Empty State */}
                    {globalMetrics.totalProjects === 0 && globalMetrics.totalKPIReports === 0 && (
                        <div className="bg-gray-800 rounded-lg p-12 border border-gray-700 text-center">
                            <div className="text-6xl mb-4">üöÄ</div>
                            <h3 className="text-2xl font-bold text-white mb-4">Comienza tu viaje con Protocolo Sinapsis</h3>
                            <p className="text-gray-400 mb-6">Crea tu primer proyecto o an√°lisis KPI para comenzar</p>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // PROJECTS MODULE - MAIN COMPONENT
        // ============================================
        function ProjectsModule() {
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [view, setView] = useState('list'); // 'list', 'project', 'analytics', 'new-project', 'new-task', 'edit-task'
            const [editingTask, setEditingTask] = useState(null);
            const [showShortcuts, setShowShortcuts] = useState(false);
            const [successFlash, setSuccessFlash] = useState('');

            const fileInputRef = useRef(null);

            // Load projects on mount
            useEffect(() => {
                const loaded = StorageOps.loadAllProjects();
                setProjects(loaded);
                if (loaded.length > 0) {
                    setCurrentProject(loaded[0]);
                    setView('project');
                }
            }, []);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    if (e.key === 'n' && view === 'project') {
                        setView('new-task');
                    } else if (e.key === 'a' && currentProject) {
                        setView('analytics');
                    } else if (e.key === 'e' && currentProject) {
                        handleExportProject();
                    } else if (e.key === '?') {
                        setShowShortcuts(true);
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [view, currentProject]);

            const showFlash = (message) => {
                setSuccessFlash(message);
                setTimeout(() => setSuccessFlash(''), 2000);
            };

            // Project Actions
            const handleCreateProject = (name) => {
                const newProject = {
                    id: `proyecto-${Date.now()}`,
                    name,
                    createdAt: new Date().toISOString(),
                    tasks: []
                };
                StorageOps.saveProject(newProject);
                const updated = [...projects, newProject];
                setProjects(updated);
                setCurrentProject(newProject);
                setView('project');
                showFlash('‚úÖ Proyecto creado');
            };

            const handleDeleteProject = (projectId) => {
                if (confirm('¬øEliminar este proyecto?')) {
                    StorageOps.deleteProject(projectId);
                    const updated = projects.filter(p => p.id !== projectId);
                    setProjects(updated);
                    if (currentProject?.id === projectId) {
                        setCurrentProject(null);
                        setView('list');
                    }
                    showFlash('üóëÔ∏è Proyecto eliminado');
                }
            };

            const handleExportProject = () => {
                if (currentProject) {
                    StorageOps.exportProject(currentProject);
                    showFlash('üì¶ Proyecto exportado');
                }
            };

            const handleImportProject = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const project = StorageOps.importProject(event.target.result);
                        project.id = `proyecto-${Date.now()}`;
                        StorageOps.saveProject(project);
                        const updated = [...projects, project];
                        setProjects(updated);
                        setCurrentProject(project);
                        setView('project');
                        showFlash('‚úÖ Proyecto importado');
                    } catch (error) {
                        alert('Error al importar: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            // Task Actions
            const handleCreateTask = (taskData) => {
                const newTask = {
                    id: Date.now(),
                    name: taskData.name,
                    status: 'pending',
                    assignedAI: taskData.assignedAI,
                    progress: 0,
                    notes: taskData.notes || '',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    history: [{
                        timestamp: new Date().toISOString(),
                        event: 'created',
                        details: 'Tarea creada',
                        user: 'Usuario'
                    }]
                };

                const updated = {
                    ...currentProject,
                    tasks: [...currentProject.tasks, newTask]
                };
                StorageOps.saveProject(updated);
                setCurrentProject(updated);
                setProjects(projects.map(p => p.id === updated.id ? updated : p));
                setView('project');
                showFlash('‚úÖ Tarea creada');
            };

            const handleUpdateTask = (taskData) => {
                const updatedTasks = currentProject.tasks.map(t => {
                    if (t.id === editingTask.id) {
                        return {
                            ...t,
                            name: taskData.name,
                            notes: taskData.notes,
                            progress: parseInt(taskData.progress),
                            lastModified: new Date().toISOString(),
                            history: [
                                ...t.history,
                                {
                                    timestamp: new Date().toISOString(),
                                    event: 'updated',
                                    details: 'Tarea actualizada',
                                    user: 'Usuario'
                                }
                            ]
                        };
                    }
                    return t;
                });

                const updated = { ...currentProject, tasks: updatedTasks };
                StorageOps.saveProject(updated);
                setCurrentProject(updated);
                setProjects(projects.map(p => p.id === updated.id ? updated : p));
                setView('project');
                setEditingTask(null);
                showFlash('‚úÖ Tarea actualizada');
            };

            const handleDeleteTask = (taskId) => {
                if (confirm('¬øEliminar esta tarea?')) {
                    const updatedTasks = currentProject.tasks.filter(t => t.id !== taskId);
                    const updated = { ...currentProject, tasks: updatedTasks };
                    StorageOps.saveProject(updated);
                    setCurrentProject(updated);
                    setProjects(projects.map(p => p.id === updated.id ? updated : p));
                    showFlash('üóëÔ∏è Tarea eliminada');
                }
            };

            const handleChangeStatus = (taskId, newStatus) => {
                const updatedTasks = currentProject.tasks.map(t => {
                    if (t.id === taskId) {
                        const oldStatus = t.status;
                        return {
                            ...t,
                            status: newStatus,
                            progress: newStatus === 'completed' ? 100 : t.progress,
                            lastModified: new Date().toISOString(),
                            history: [
                                ...t.history,
                                {
                                    timestamp: new Date().toISOString(),
                                    event: 'status_change',
                                    details: `${oldStatus} ‚Üí ${newStatus}`,
                                    user: 'Usuario'
                                }
                            ]
                        };
                    }
                    return t;
                });

                const updated = { ...currentProject, tasks: updatedTasks };
                StorageOps.saveProject(updated);
                setCurrentProject(updated);
                setProjects(projects.map(p => p.id === updated.id ? updated : p));
                showFlash(`‚úÖ Estado ‚Üí ${newStatus}`);
            };

            const handleChangeAI = (taskId, newAI) => {
                const updatedTasks = currentProject.tasks.map(t => {
                    if (t.id === taskId) {
                        const oldAI = t.assignedAI;
                        return {
                            ...t,
                            assignedAI: newAI,
                            lastModified: new Date().toISOString(),
                            history: [
                                ...t.history,
                                {
                                    timestamp: new Date().toISOString(),
                                    event: 'ai_assigned',
                                    details: `${oldAI} ‚Üí ${newAI}`,
                                    user: 'Usuario'
                                }
                            ]
                        };
                    }
                    return t;
                });

                const updated = { ...currentProject, tasks: updatedTasks };
                StorageOps.saveProject(updated);
                setCurrentProject(updated);
                setProjects(projects.map(p => p.id === updated.id ? updated : p));
                showFlash('üîÑ Especialista cambiado');
            };

            // Render: New Project Form
            if (view === 'new-project') {
                return (
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-gray-800 rounded-lg p-8 border border-gray-700">
                            <h2 className="text-2xl font-bold text-white mb-6">‚ûï Nuevo Proyecto</h2>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const formData = new FormData(e.target);
                                handleCreateProject(formData.get('name'));
                            }}>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Nombre del Proyecto</label>
                                    <input
                                        name="name"
                                        type="text"
                                        required
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                        placeholder="Ej: Implementaci√≥n Sistema CRM"
                                    />
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                    >
                                        Crear Proyecto
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setView('list')}
                                        className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            // Render: Project List
            if (view === 'list') {
                return (
                    <div>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">üéØ Proyectos</h2>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setView('new-project')}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                >
                                    ‚ûï Nuevo Proyecto
                                </button>
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="px-6 py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition"
                                >
                                    üì• Importar
                                </button>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".json"
                                    onChange={handleImportProject}
                                    className="hidden"
                                />
                            </div>
                        </div>

                        {projects.length === 0 ? (
                            <div className="bg-gray-800 rounded-lg p-12 border border-gray-700 text-center">
                                <div className="text-6xl mb-4">üéØ</div>
                                <h3 className="text-2xl font-bold text-white mb-4">No hay proyectos todav√≠a</h3>
                                <p className="text-gray-400 mb-6">Comienza creando tu primer proyecto</p>
                                <button
                                    onClick={() => setView('new-project')}
                                    className="px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                >
                                    üöÄ Crear Primer Proyecto
                                </button>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {projects.map(project => {
                                    const analytics = calculateAnalytics(project);
                                    return (
                                        <div key={project.id} className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-purple-500 transition task-card">
                                            <div className="flex items-start justify-between mb-4">
                                                <div>
                                                    <h3 className="text-xl font-bold text-white mb-2">{project.name}</h3>
                                                    <p className="text-sm text-gray-400">{getTimeAgo(project.createdAt)}</p>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 gap-3 mb-4">
                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                    <p className="text-xs text-gray-400">Tareas</p>
                                                    <p className="text-lg font-bold text-white">{analytics.totalTasks}</p>
                                                </div>
                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                    <p className="text-xs text-gray-400">Completadas</p>
                                                    <p className="text-lg font-bold text-green-400">{analytics.completedTasks}</p>
                                                </div>
                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                    <p className="text-xs text-gray-400">Score</p>
                                                    <p className="text-lg font-bold text-blue-400">{analytics.synapsisScore}</p>
                                                </div>
                                            </div>

                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        setCurrentProject(project);
                                                        setView('project');
                                                    }}
                                                    className="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-sm font-semibold"
                                                >
                                                    Abrir
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteProject(project.id)}
                                                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            }

            // Render: New Task Form
            if (view === 'new-task') {
                return (
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-gray-800 rounded-lg p-8 border border-gray-700">
                            <h2 className="text-2xl font-bold text-white mb-6">‚ûï Nueva Tarea</h2>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const formData = new FormData(e.target);
                                const taskData = {
                                    name: formData.get('name'),
                                    assignedAI: formData.get('ai'),
                                    notes: formData.get('notes')
                                };
                                
                                // Check for AI suggestion
                                const suggested = suggestSpecialist(taskData.name, taskData.notes);
                                if (suggested && suggested !== taskData.assignedAI) {
                                    const ai = AISpecialists.find(s => s.id === suggested);
                                    if (confirm(`üí° Sugerencia: ${ai?.name} podr√≠a ser mejor para esta tarea. ¬øUsar ${ai?.name}?`)) {
                                        taskData.assignedAI = suggested;
                                    }
                                }
                                
                                handleCreateTask(taskData);
                            }}>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Nombre de la Tarea</label>
                                        <input
                                            name="name"
                                            type="text"
                                            required
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                            placeholder="Ej: Dise√±o de arquitectura del sistema"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Especialista IA</label>
                                        <select
                                            name="ai"
                                            required
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                        >
                                            {AISpecialists.map(ai => (
                                                <option key={ai.id} value={ai.id}>
                                                    {ai.name} - {ai.role}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Notas (opcional)</label>
                                        <textarea
                                            name="notes"
                                            rows="4"
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                            placeholder="Detalles adicionales..."
                                        ></textarea>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                    >
                                        Crear Tarea
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setView('project')}
                                        className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            // Render: Edit Task Form
            if (view === 'edit-task' && editingTask) {
                return (
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-gray-800 rounded-lg p-8 border border-gray-700">
                            <h2 className="text-2xl font-bold text-white mb-6">‚úèÔ∏è Editar Tarea</h2>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const formData = new FormData(e.target);
                                handleUpdateTask({
                                    name: formData.get('name'),
                                    notes: formData.get('notes'),
                                    progress: formData.get('progress')
                                });
                            }}>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Nombre de la Tarea</label>
                                        <input
                                            name="name"
                                            type="text"
                                            required
                                            defaultValue={editingTask.name}
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Progreso (%)</label>
                                        <input
                                            name="progress"
                                            type="number"
                                            min="0"
                                            max="100"
                                            required
                                            defaultValue={editingTask.progress}
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Notas</label>
                                        <textarea
                                            name="notes"
                                            rows="4"
                                            defaultValue={editingTask.notes}
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none"
                                        ></textarea>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                    >
                                        Guardar Cambios
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setView('project');
                                            setEditingTask(null);
                                        }}
                                        className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            // Render: Analytics View
            if (view === 'analytics') {
                return (
                    <div>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">üìä Analytics Dashboard</h2>
                            <button
                                onClick={() => setView('project')}
                                className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                            >
                                ‚Üê Volver
                            </button>
                        </div>
                        <AnalyticsDashboard project={currentProject} />
                    </div>
                );
            }

            // Render: Project View (Main)
            const pendingTasks = currentProject.tasks.filter(t => t.status === 'pending');
            const activeTasks = currentProject.tasks.filter(t => t.status === 'active');
            const completedTasks = currentProject.tasks.filter(t => t.status === 'completed');
            const blockedTasks = currentProject.tasks.filter(t => t.status === 'blocked');

            return (
                <div>
                    {/* Project Header */}
                    <div className="mb-6">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <button
                                    onClick={() => setView('list')}
                                    className="text-purple-400 hover:text-purple-300 mb-2 text-sm"
                                >
                                    ‚Üê Todos los proyectos
                                </button>
                                <h2 className="text-2xl font-bold text-white">{currentProject.name}</h2>
                                <p className="text-sm text-gray-400">Creado {getTimeAgo(currentProject.createdAt)}</p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setView('new-task')}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                >
                                    ‚ûï Nueva Tarea
                                </button>
                                <button
                                    onClick={() => setView('analytics')}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    üìä Analytics
                                </button>
                                <button
                                    onClick={handleExportProject}
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                >
                                    üì¶ Exportar
                                </button>
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                >
                                    üì• Importar
                                </button>
                                <button
                                    onClick={() => setShowShortcuts(true)}
                                    className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                                >
                                    ‚å®Ô∏è
                                </button>
                            </div>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".json"
                                onChange={handleImportProject}
                                className="hidden"
                            />
                        </div>

                        {/* Quick Stats */}
                        <div className="grid grid-cols-4 gap-4">
                            <div className="bg-yellow-900 bg-opacity-30 rounded-lg p-4 border border-yellow-700">
                                <div className="text-2xl font-bold text-yellow-400">{pendingTasks.length}</div>
                                <div className="text-sm text-yellow-300">Pendientes</div>
                            </div>
                            <div className="bg-blue-900 bg-opacity-30 rounded-lg p-4 border border-blue-700">
                                <div className="text-2xl font-bold text-blue-400">{activeTasks.length}</div>
                                <div className="text-sm text-blue-300">Activas</div>
                            </div>
                            <div className="bg-green-900 bg-opacity-30 rounded-lg p-4 border border-green-700">
                                <div className="text-2xl font-bold text-green-400">{completedTasks.length}</div>
                                <div className="text-sm text-green-300">Completadas</div>
                            </div>
                            <div className="bg-red-900 bg-opacity-30 rounded-lg p-4 border border-red-700">
                                <div className="text-2xl font-bold text-red-400">{blockedTasks.length}</div>
                                <div className="text-sm text-red-300">Bloqueadas</div>
                            </div>
                        </div>
                    </div>

                    {/* Tasks by Status */}
                    <div className="space-y-8">
                        {/* Blocked Tasks */}
                        {blockedTasks.length > 0 && (
                            <div>
                                <h3 className="text-xl font-bold text-red-400 mb-4">üö´ Bloqueadas ({blockedTasks.length})</h3>
                                <div className="space-y-4">
                                    {blockedTasks.map(task => (
                                        <TaskCard
                                            key={task.id}
                                            task={task}
                                            onEdit={(task) => {
                                                setEditingTask(task);
                                                setView('edit-task');
                                            }}
                                            onChangeStatus={handleChangeStatus}
                                            onChangeAI={handleChangeAI}
                                            onDelete={handleDeleteTask}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Active Tasks */}
                        {activeTasks.length > 0 && (
                            <div>
                                <h3 className="text-xl font-bold text-blue-400 mb-4">‚ö° Activas ({activeTasks.length})</h3>
                                <div className="space-y-4">
                                    {activeTasks.map(task => (
                                        <TaskCard
                                            key={task.id}
                                            task={task}
                                            onEdit={(task) => {
                                                setEditingTask(task);
                                                setView('edit-task');
                                            }}
                                            onChangeStatus={handleChangeStatus}
                                            onChangeAI={handleChangeAI}
                                            onDelete={handleDeleteTask}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Pending Tasks */}
                        {pendingTasks.length > 0 && (
                            <div>
                                <h3 className="text-xl font-bold text-yellow-400 mb-4">‚è≥ Pendientes ({pendingTasks.length})</h3>
                                <div className="space-y-4">
                                    {pendingTasks.map(task => (
                                        <TaskCard
                                            key={task.id}
                                            task={task}
                                            onEdit={(task) => {
                                                setEditingTask(task);
                                                setView('edit-task');
                                            }}
                                            onChangeStatus={handleChangeStatus}
                                            onChangeAI={handleChangeAI}
                                            onDelete={handleDeleteTask}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Completed Tasks */}
                        {completedTasks.length > 0 && (
                            <div>
                                <h3 className="text-xl font-bold text-green-400 mb-4">‚úÖ Completadas ({completedTasks.length})</h3>
                                <div className="space-y-4">
                                    {completedTasks.map(task => (
                                        <TaskCard
                                            key={task.id}
                                            task={task}
                                            onEdit={(task) => {
                                                setEditingTask(task);
                                                setView('edit-task');
                                            }}
                                            onChangeStatus={handleChangeStatus}
                                            onChangeAI={handleChangeAI}
                                            onDelete={handleDeleteTask}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* No Tasks */}
                    {currentProject.tasks.length === 0 && (
                        <div className="bg-gray-800 rounded-lg p-12 border border-gray-700 text-center">
                            <div className="text-6xl mb-4">üìù</div>
                            <h3 className="text-2xl font-bold text-white mb-4">No hay tareas todav√≠a</h3>
                            <p className="text-gray-400 mb-6">Comienza agregando tu primera tarea</p>
                            <button
                                onClick={() => setView('new-task')}
                                className="px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                            >
                                ‚ûï Crear Primera Tarea
                            </button>
                        </div>
                    )}

                    {/* Shortcuts Modal */}
                    {showShortcuts && <ShortcutsModal onClose={() => setShowShortcuts(false)} />}

                    {/* Success Flash */}
                    {successFlash && (
                        <div className="fixed top-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg success-flash z-50">
                            {successFlash}
                        </div>
                    )}
                </div>
            );
        }


        // ============================================
        // EV OPS MODULE - CARGA EL√âCTRICA (DEMO)
        // ============================================
        function EvOpsModule({ onGoProjects, onGoKpi, selectedStationId, onSelectStation, focusStationId }) {
            const [stations, setStations] = useState([]);
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all'); // all | available | occupied | queue | offline
            const [autoRefresh, setAutoRefresh] = useState(true);


            // Enfoque r√°pido desde otros m√≥dulos (ej. ticket ‚Üí volver a EV Ops)
            useEffect(() => {
                if (!focusStationId) return;
                const st = stations.find(s => s.id === focusStationId);
                if (st) setSearch(st.name);
            }, [focusStationId, stations]);

            const loadStations = () => {
                const loaded = StorageOps.loadAllEVStations();
                setStations(loaded);
            };

            useEffect(() => {
                loadStations();
            }, []);

            useEffect(() => {
                if (!autoRefresh) return;
                const id = setInterval(() => {
                    // Simula ‚Äúcasi tiempo real‚Äù sin depender de datos internos
                    simulateTick(2);
                }, 8000);
                return () => clearInterval(id);
            }, [autoRefresh, stations]);

            const normalize = (s) => (s || '').toLowerCase().trim();

            const stationsFiltered = React.useMemo(() => {
                const q = normalize(search);
                return stations.filter(st => {
                    const matchesQuery = !q ||
                        normalize(st.name).includes(q) ||
                        normalize(st.comuna).includes(q) ||
                        normalize(st.address).includes(q);
                    const matchesFilter = filter === 'all' ? true : st.status === filter;
                    return matchesQuery && matchesFilter;
                });
            }, [stations, search, filter]);

            const metrics = React.useMemo(() => {
                const total = stations.length || 1;
                const offline = stations.filter(s => s.status === 'offline').length;
                const available = stations.filter(s => s.status === 'available').length;
                const queueStations = stations.filter(s => s.status === 'queue').length;
                const occupied = stations.filter(s => s.status === 'occupied').length;

                const uptime = (((total - offline) / total) * 100).toFixed(1);
                const avgOcc = stations.length
                    ? (stations.reduce((sum, s) => sum + (s.occupancy || 0), 0) / stations.length).toFixed(0)
                    : 0;
                const totalQueue = stations.reduce((sum, s) => sum + (s.queue || 0), 0);

                return { total, offline, available, queueStations, occupied, uptime, avgOcc, totalQueue };
            }, [stations]);

            const statusLabel = (st) => {
                const map = {
                    available: 'Disponible',
                    occupied: 'Ocupado',
                    queue: 'Con cola',
                    offline: 'Fuera de servicio'
                };
                return map[st] || '‚Äî';
            };

            const statusStyle = (st) => {
                const map = {
                    available: 'bg-green-700/30 border-green-500 text-green-200',
                    occupied: 'bg-blue-700/30 border-blue-500 text-blue-200',
                    queue: 'bg-yellow-700/30 border-yellow-500 text-yellow-200',
                    offline: 'bg-red-700/30 border-red-500 text-red-200'
                };
                return map[st] || 'bg-gray-700/30 border-gray-500 text-gray-200';
            };

            const randomPick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            const simulateTick = (n = 4) => {
                if (!stations.length) return;
                const updated = [...stations];

                const candidates = updated
                    .map((s, idx) => ({ s, idx }))
                    .sort(() => Math.random() - 0.5)
                    .slice(0, Math.min(n, updated.length));

                candidates.forEach(({ s, idx }) => {
                    const next = randomPick(['available', 'occupied', 'queue', 'offline']);
                    const occupancy = next === 'available' ? 0 : (next === 'offline' ? Math.floor(Math.random() * 20) : Math.floor(60 + Math.random() * 40));
                    const queue = next === 'queue' ? Math.floor(1 + Math.random() * 5) : 0;

                    const newStation = {
                        ...s,
                        status: next,
                        occupancy,
                        queue,
                        lastUpdate: new Date().toISOString()
                    };

                    updated[idx] = newStation;
                    StorageOps.saveEVStation(newStation);
                });

                setStations(updated);
            };

            const ensureEvProject = () => {
                const all = StorageOps.loadAllProjects();
                const existing = all.find(p => p.id === 'evops-santiago');
                if (existing) return existing;

                const project = {
                    id: 'evops-santiago',
                    name: 'EV Ops Santiago (Piloto)',
                    description: 'Proyecto para convertir ‚Äúpuntos ciegos‚Äù en m√©tricas + acciones.',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    tasks: []
                };
                StorageOps.saveProject(project);
                return project;
            };

            const createTicket = (station) => {
                const project = ensureEvProject();
                const taskId = Date.now();
                const severity = station.status === 'offline' ? 'blocked' : 'pending';

                const task = {
                    id: taskId,
                    name: `Ticket EV: ${statusLabel(station.status)} - ${station.name}`,
                    status: severity,
                    assignedAI: 'gpt4',
                    progress: 0,
                    notes: `Origen: EV Ops\nComuna: ${station.comuna}\nDirecci√≥n: ${station.address}\nPotencia: ${station.powerKW}kW\nConectores: ${(station.connectors || []).join(', ')}\nCoordenadas: ${station.lat}, ${station.lng}\nAcci√≥n sugerida: diagn√≥stico + comunicaci√≥n a usuarios + SLA`,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    history: [
                        { timestamp: new Date().toISOString(), event: 'created', details: 'Ticket creado desde EV Ops', user: 'Sistema' },
                        { timestamp: new Date().toISOString(), event: 'ai_assigned', details: 'Asignado a GPT-4', user: 'Sistema' }
                    ]
                };

                const updatedProject = {
                    ...project,
                    tasks: [task, ...(project.tasks || [])]
                };

                StorageOps.saveProject(updatedProject);

                if (onSelectStation) onSelectStation(station.id);
                if (onGoProjects) onGoProjects({ station, taskId, projectId: project.id });
            };

            const projectHint = '';

            // Map bounds (aprox) para Santiago
            const bounds = { latMin: -33.65, latMax: -33.33, lngMin: -70.80, lngMax: -70.52 };

            const toXY = (st) => {
                const x = ((st.lng - bounds.lngMin) / (bounds.lngMax - bounds.lngMin)) * 100;
                const y = (1 - (st.lat - bounds.latMin) / (bounds.latMax - bounds.latMin)) * 100;
                return { x: Math.min(98, Math.max(2, x)), y: Math.min(96, Math.max(4, y)) };
            };
            const selectedStation = stations.find(s => s.id === selectedStationId) || null;


            return (
                <div>
                    <div className="mb-8">
                        <h2 className="text-3xl font-bold text-white mb-2">‚ö° EV Ops ‚Äî Puntos de Carga</h2>
                        {selectedStation && (
                            <div className="text-sm text-gray-300 mt-1">
                                Contexto actual: <span className="font-semibold text-white">{selectedStation.name}</span>
                                <span className="text-gray-500"> ¬∑ </span>
                                <span className="text-gray-400">Estado:</span> <span className="font-semibold text-white">{selectedStation.status}</span>
                            </div>
                        )}

                        <p className="text-gray-400">
                            Datos simulados para mostrar el salto: visibilidad + m√©tricas + acciones (sin tocar datos internos).
                        </p>
                    </div>

                    {/* Executive KPIs */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="text-sm text-gray-400 mb-1">Estaciones</div>
                            <div className="text-3xl font-bold text-blue-300">{metrics.total}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="text-sm text-gray-400 mb-1">Uptime</div>
                            <div className="text-3xl font-bold text-green-300">{metrics.uptime}%</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="text-sm text-gray-400 mb-1">Disponibles</div>
                            <div className="text-3xl font-bold text-green-200">{metrics.available}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="text-sm text-gray-400 mb-1">Fuera de servicio</div>
                            <div className="text-3xl font-bold text-red-300">{metrics.offline}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="text-sm text-gray-400 mb-1">Cola total</div>
                            <div className="text-3xl font-bold text-yellow-200">{metrics.totalQueue}</div>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 mb-6 flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
                        <div className="flex gap-3 items-center">
                            <input
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 text-white w-full md:w-96"
                                placeholder="Buscar por estaci√≥n, comuna o direcci√≥n..."
                            />
                            <select
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 text-white"
                            >
                                <option value="all">Todas</option>
                                <option value="available">Disponibles</option>
                                <option value="occupied">Ocupadas</option>
                                <option value="queue">Con cola</option>
                                <option value="offline">Fuera de servicio</option>
                            </select>
                        </div>

                        <div className="flex flex-wrap gap-3 items-center justify-end">
                            <button
                                onClick={() => simulateTick(6)}
                                className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg font-semibold"
                            >
                                üîÑ Simular actualizaci√≥n
                            </button>

                            <button
                                onClick={() => StorageOps.exportEVStations(stations)}
                                className="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg font-semibold"
                            >
                                ‚¨áÔ∏è Exportar JSON
                            </button>

                            <button
                                onClick={() => setAutoRefresh(!autoRefresh)}
                                className={`px-4 py-2 rounded-lg font-semibold ${autoRefresh ? 'bg-green-700/30 border border-green-600' : 'bg-gray-900 border border-gray-700'}`}
                            >
                                {autoRefresh ? 'üü¢ Auto: ON' : '‚ö™ Auto: OFF'}
                            </button>
                        </div>
                    </div>

                    {/* Map + List */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Map */}
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-bold text-white">üó∫Ô∏è ‚ÄúMapa vivo‚Äù</h3>
                                <div className="text-xs text-gray-400">Puntos = estaciones (posici√≥n aproximada)</div>
                            </div>

                            <div className="relative w-full h-80 bg-gray-900 border border-gray-700 rounded-lg overflow-hidden">
                                <div className="absolute inset-0 opacity-20" style={{ backgroundImage: 'radial-gradient(circle, rgba(255,255,255,0.12) 1px, transparent 1px)', backgroundSize: '18px 18px' }} />
                                {stationsFiltered.map(st => {
                                    const { x, y } = toXY(st);
                                    const dot =
                                        st.status === 'available' ? 'bg-green-400' :
                                        st.status === 'occupied' ? 'bg-blue-400' :
                                        st.status === 'queue' ? 'bg-yellow-400' : 'bg-red-400';
                                    return (
                                        <button
                                            key={st.id}
                                            className={`absolute w-3 h-3 rounded-full ${dot} hover:scale-125 transition-transform`}
                                            style={{ left: `${x}%`, top: `${y}%` }}
                                            title={`${st.name} ‚Ä¢ ${st.comuna} ‚Ä¢ ${statusLabel(st.status)}`}
                                            onClick={() => setSearch(st.name)}
                                        />
                                    );
                                })}
                                <div className="absolute bottom-3 left-3 text-xs text-gray-400 bg-gray-950/60 px-3 py-2 rounded-lg border border-gray-700">
                                    {projectHint}
                                </div>
                            </div>
                        </div>

                        {/* List */}
                        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-bold text-white">üìç Estaciones</h3>
                                <div className="text-sm text-gray-400">{stationsFiltered.length} visibles</div>
                            </div>

                            <div className="space-y-3 max-h-[420px] overflow-auto pr-2">
                                {stationsFiltered.map(st => (
                                    <div key={st.id} className="bg-gray-900 rounded-lg p-4 border border-gray-700">
                                        <div className="flex items-start justify-between gap-4">
                                            <div>
                                                <div className="text-white font-semibold">{st.name}</div>
                                                <div className="text-sm text-gray-400">{st.comuna} ‚Ä¢ {st.powerKW}kW ‚Ä¢ {(st.connectors || []).join(' / ')}</div>
                                                <div className="text-xs text-gray-500 mt-1">{st.address}</div>
                                                <div className="text-xs text-gray-500 mt-1">√ölt. actualizaci√≥n: {formatDateTime(st.lastUpdate)}</div>
                                            </div>

                                            <div className="flex flex-col items-end gap-2">
                                                <div className={`px-3 py-1 rounded-full border text-xs font-semibold ${statusStyle(st.status)}`}>
                                                    {statusLabel(st.status)}
                                                </div>

                                                <div className="text-xs text-gray-400">
                                                    Ocupaci√≥n: <span className="text-white font-semibold">{st.occupancy || 0}%</span>
                                                    {st.queue ? <> ‚Ä¢ Cola: <span className="text-white font-semibold">{st.queue}</span></> : null}
                                                </div>

                                                {(st.status === 'offline' || st.status === 'queue') && (
                                                    <button
                                                        onClick={() => createTicket(st)}
                                                        className="px-3 py-2 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg text-sm font-semibold"
                                                    >
                                                        üßæ Crear ticket
                                                    </button>
                                                )}
                                            
                                                <button
                                                    onClick={() => { if (onSelectStation) onSelectStation(st.id); if (onGoKpi) onGoKpi(st); }}
                                                    className="px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg text-sm font-semibold hover:bg-gray-700 transition"
                                                >
                                                    üìä Ver KPIs EV
                                                </button>
                                                <button
                                                    onClick={() => { if (onSelectStation) onSelectStation(st.id); }}
                                                    className="px-4 py-2 bg-gray-900 border border-gray-700 text-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-800 transition"
                                                >
                                                    üéØ Seleccionar
                                                </button>
</div>
                                        </div>
                                    </div>
                                ))}

                                {stationsFiltered.length === 0 && (
                                    <div className="text-center text-gray-400 py-10">
                                        No hay estaciones para ese filtro/b√∫squeda.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        

        // ============================================
        // EV DATA HUB - KPI EV + EXPORTS (sin tocar KPI Analytics)
        // ============================================
        function EvDataHubModule({selectedStationId, onSelectStation, onGoEvOps, onGoKpiAnalytics, onGoProjects, onGoKpiEvOps}) {
            const [stations, setStations] = useState([]);
            const [scope, setScope] = useState('city'); // 'city' | 'station'
            const [autoRefresh, setAutoRefresh] = useState(true);

            const loadStations = () => {
                const loaded = StorageOps.loadAllEVStations();
                setStations(loaded);
            };

            useEffect(() => {
                loadStations();
            }, []);

            useEffect(() => {
                if (!autoRefresh) return;
                const id = setInterval(() => loadStations(), 12000);
                return () => clearInterval(id);
            }, [autoRefresh]);

            const selectedStation = stations.find(s => s.id === selectedStationId) || null;
            const scopeStations = (scope === 'station' && selectedStation) ? [selectedStation] : stations;

            const sum = (arr, fn) => arr.reduce((acc, x) => acc + (fn(x) || 0), 0);
            const count = (arr, fn) => arr.reduce((acc, x) => acc + (fn(x) ? 1 : 0), 0);

            const total = scopeStations.length || 0;
            const nAvailable = count(scopeStations, s => s.status === 'available');
            const nOccupied  = count(scopeStations, s => s.status === 'occupied');
            const nOffline   = count(scopeStations, s => s.status === 'offline');
            const avgQueue   = total ? (sum(scopeStations, s => Number(s.queue || 0)) / total) : 0;
            const powerInstalled = sum(scopeStations, s => Number(s.powerKW || 0));
            const powerActiveEst = sum(scopeStations, s => (s.status === 'occupied' ? Number(s.powerKW || 0) * 0.7 : 0)); // estimaci√≥n transparente

            const pct = (n) => total ? Math.round((n / total) * 100) : 0;

            const kpis = {
                availability_pct: pct(nAvailable),
                occupancy_pct: pct(nOccupied),
                offline_count: nOffline,
                avg_queue: Number(avgQueue.toFixed(1)),
                active_power_kw_est: Math.round(powerActiveEst)
            };

            const downloadText = (filename, content, mime) => {
                const blob = new Blob([content], { type: mime || 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            };

            const exportJSON = () => {
                const payload = {
                    platform: 'Protocolo Sinapsis v0.9 (EV Ops)',
                    generated_at: new Date().toISOString(),
                    scope: scope,
                    selected_station_id: selectedStationId || null,
                    kpis,
                    stations: scopeStations
                };
                downloadText(`sinapsis-ev-kpis-${scope}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
            };

            const exportCSV = () => {
                const header = ['id','name','comuna','address','status','powerKW','queue','lastUpdate'];
                const rows = scopeStations.map(s => [
                    s.id,
                    (s.name || '').replaceAll('"','""'),
                    (s.comuna || '').replaceAll('"','""'),
                    (s.address || '').replaceAll('"','""'),
                    s.status,
                    s.powerKW,
                    s.queue,
                    s.lastUpdate
                ]);
                const csv = [
                    header.join(','),
                    ...rows.map(r => r.map(v => `"${String(v ?? '').replaceAll('"','""')}"`).join(','))
                ].join('\n');
                downloadText(`sinapsis-ev-stations-${scope}.csv`, csv, 'text/csv;charset=utf-8');
            };

            const exportPDF = () => {
                const payload = {
                    platform: 'Protocolo Sinapsis v0.9 (EV Ops)',
                    generated_at: new Date().toISOString(),
                    scope: scope,
                    selected_station_id: selectedStationId || null,
                    kpis,
                    stations: scopeStations
                };

                // Fill print report (Reporte comit√©)
                const meta = document.getElementById('spr_meta');
                if (meta) meta.textContent = new Date(payload.generated_at).toLocaleString();

                const scopeEl = document.getElementById('spr_scope');
                const ticketEl = document.getElementById('spr_ticket');
                const kpiBox = document.getElementById('spr_kpis');

                if (payload.scope === 'station' && payload.stations && payload.stations[0]) {
                    const st = payload.stations[0];
                    if (scopeEl) scopeEl.textContent = `Estaci√≥n: ${String(st.id || '').toUpperCase()} ¬∑ ${st.comuna || ''}`;
                    if (ticketEl) {
                        // Demo: ticket info lives in Proyectos & Tareas; aqu√≠ mostramos contexto de estaci√≥n.
                        ticketEl.textContent = `Estado: ${st.status} ¬∑ Cola: ${st.queue ?? 0} ¬∑ Potencia: ${st.powerKW ?? ''} kW`;
                    }
                } else {
                    if (scopeEl) scopeEl.textContent = 'Ciudad: vista general';
                    if (ticketEl) ticketEl.textContent = 'Resumen agregado (todas las estaciones)';
                }

                if (kpiBox) {
                    kpiBox.innerHTML = `
                        <div class="kpi"><div class="t">Disponibilidad</div><div class="v">${payload.kpis.availability_pct}%</div></div>
                        <div class="kpi"><div class="t">Ocupaci√≥n</div><div class="v">${payload.kpis.occupancy_pct}%</div></div>
                        <div class="kpi"><div class="t">Offline</div><div class="v">${payload.kpis.offline_count}</div></div>
                        <div class="kpi"><div class="t">Cola prom.</div><div class="v">${payload.kpis.avg_queue}</div></div>
                        <div class="kpi"><div class="t">Potencia activa</div><div class="v">${payload.kpis.active_power_kw_est} kW</div></div>
                    `;
                }

                // Print dialog -> Guardar como PDF
                window.print();
            };


            return (
                <div className="bg-gray-900/40 border border-gray-700 rounded-2xl p-6">
                    <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4 mb-5">
                        <div>
                            <h2 className="text-2xl font-bold text-white">üß© EV Data Hub</h2>
                            <p className="text-gray-300 mt-1">
                                KPI EV + exportables <span className="text-gray-400">(JSON / CSV‚ÄëExcel)</span> 
                            </p>
                            <p className="text-xs text-gray-400 mt-2">
                                
                            </p>
                        </div>

                        <div className="flex flex-wrap gap-2">
                            <button onClick={() => onGoEvOps(selectedStationId)} className="px-4 py-2 bg-yellow-700 hover:bg-yellow-800 text-white rounded-lg text-sm font-semibold transition">
                                üó∫Ô∏è Ir a EV Ops (mapa)
                            </button>
                            <button onClick={() => onGoProjects && onGoProjects()} className="px-4 py-2 bg-purple-700 hover:bg-purple-800 text-white rounded-lg text-sm font-semibold transition">
                                üéØ Proyectos
                            </button>
                            <button onClick={() => onGoKpiAnalytics && onGoKpiAnalytics()} className="px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-lg text-sm font-semibold transition">
                                üìä KPI Analytics
                            </button>
                        <button onClick={() => onGoKpiEvOps && onGoKpiEvOps(selectedStationId)} className="px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg text-sm font-semibold transition">
                                ‚ö° KPI EV Ops Carga
                            </button>
                            </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-white font-semibold mb-2">‚ö° Contexto EV</div>
                            <div className="flex flex-col gap-2">
                                <select
                                    value={selectedStationId}
                                    onChange={(e) => onSelectStation && onSelectStation(e.target.value)}
                                    className="px-3 py-2 bg-gray-900 border border-gray-700 text-white rounded-lg text-sm"
                                >
                                    <option value="">Ciudad (todas las estaciones)</option>
                                    {stations.map(s => (
                                        <option key={s.id} value={s.id}>{s.name}</option>
                                    ))}
                                </select>

                                <div className="flex items-center justify-between gap-2 text-xs text-gray-400">
                                    <div>Auto-refresh</div>
                                    <button
                                        onClick={() => setAutoRefresh(a => !a)}
                                        className={`px-3 py-1 rounded-lg border ${autoRefresh ? 'border-green-600 bg-green-900/40 text-green-200' : 'border-gray-600 bg-gray-800 text-gray-300'}`}
                                    >
                                        {autoRefresh ? 'ON' : 'OFF'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-white font-semibold mb-2">üéõÔ∏è Alcance KPI EV</div>
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={() => setScope('city')}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold transition border ${scope === 'city' ? 'bg-gray-800 border-gray-500 text-white' : 'bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800'}`}
                                >
                                    üèôÔ∏è Ciudad
                                </button>
                                <button
                                    onClick={() => setScope('station')}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold transition border ${scope === 'station' ? 'bg-gray-800 border-gray-500 text-white' : 'bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800'}`}
                                    disabled={!selectedStation}
                                    title={!selectedStation ? 'Selecciona una estaci√≥n para KPI por estaci√≥n' : 'KPI por estaci√≥n'}
                                >
                                    üìç Estaci√≥n
                                </button>
                            </div>
                            <div className="text-xs text-gray-400 mt-2">
                                
                            Tip: PDF comit√© se genera con Imprimir ‚Üí Guardar como PDF (sin datos personales).</div>
                        </div>

                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-white font-semibold mb-2">‚¨áÔ∏è Exportar datos</div>
                            <div className="flex flex-wrap gap-2">
                                <button onClick={exportJSON} className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-semibold transition border border-gray-700">
                                    JSON KPIs
                                </button>
                                <button onClick={exportCSV} className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-semibold transition border border-gray-700">
                                    CSV Estaciones
                                </button>
                            
                                <button onClick={exportPDF} className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-semibold transition border border-gray-700">
                                    PDF comit√©
                                </button>
</div>
                            <div className="text-xs text-gray-400 mt-2">
                                
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-xs text-gray-400">Disponibilidad</div>
                            <div className="text-3xl font-bold text-white">{kpis.availability_pct}%</div>
                            <div className="text-xs text-gray-500 mt-1">Estaciones ‚Äúavailable‚Äù / total</div>
                        </div>
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-xs text-gray-400">Ocupaci√≥n</div>
                            <div className="text-3xl font-bold text-white">{kpis.occupancy_pct}%</div>
                            <div className="text-xs text-gray-500 mt-1">Estaciones ‚Äúoccupied‚Äù / total</div>
                        </div>
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-xs text-gray-400">Offline (conteo)</div>
                            <div className="text-3xl font-bold text-white">{kpis.offline_count}</div>
                            <div className="text-xs text-gray-500 mt-1">Se√±al perdida / falla operativa</div>
                        </div>
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-xs text-gray-400">Cola promedio</div>
                            <div className="text-3xl font-bold text-white">{kpis.avg_queue}</div>
                            <div className="text-xs text-gray-500 mt-1">Personas/veh√≠culos esperando</div>
                        </div>
                        <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                            <div className="text-xs text-gray-400">Potencia activa (est.)</div>
                            <div className="text-3xl font-bold text-white">{kpis.active_power_kw_est} kW</div>
                            <div className="text-xs text-gray-500 mt-1">Estimaci√≥n: 70% de potencia nominal en ocupados</div>
                        </div>
                    </div>
                </div>
            );
        }

// ============================================
        // KPI MODULE - UI COMPONENTS
        // ============================================
        function KPIForm({ onCalculate, onCancel }) {
            const [selectedAI, setSelectedAI] = useState('claude');

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="bg-gray-800 rounded-lg p-8 border border-gray-700">
                        <h2 className="text-2xl font-bold text-white mb-6">üìä Nuevo An√°lisis KPI</h2>
                        
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const data = {
                                companyName: formData.get('companyName'),
                                departmentName: formData.get('departmentName'),
                                period: formData.get('period'),
                                revenue: parseFloat(formData.get('revenue')),
                                previousRevenue: parseFloat(formData.get('previousRevenue')),
                                costOfSales: parseFloat(formData.get('costOfSales')),
                                marketingInvestment: parseFloat(formData.get('marketingInvestment')),
                                employees: parseInt(formData.get('employees')),
                                leads: parseInt(formData.get('leads')),
                                sales: parseInt(formData.get('sales')),
                                customers: parseInt(formData.get('customers')),
                                returningCustomers: parseInt(formData.get('returningCustomers')),
                                expenses: parseFloat(formData.get('expenses')),
                                months: parseInt(formData.get('months'))
                            };
                            onCalculate(data, selectedAI);
                        }}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Empresa</label>
                                    <input name="companyName" type="text" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Departamento/√Årea</label>
                                    <input name="departmentName" type="text" className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Per√≠odo</label>
                                    <input name="period" type="text" required placeholder="Ej: Q3 2024" className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Especialista IA</label>
                                    <select value={selectedAI} onChange={(e) => setSelectedAI(e.target.value)} className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none">
                                        {AISpecialists.map(ai => (
                                            <option key={ai.id} value={ai.id}>{ai.name} - {ai.role}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="border-t border-gray-700 pt-6 mb-6">
                                <h3 className="text-lg font-bold text-white mb-4">Datos Financieros</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Revenue Actual</label>
                                        <input name="revenue" type="number" step="0.01" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Revenue Anterior</label>
                                        <input name="previousRevenue" type="number" step="0.01" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Costo de Ventas</label>
                                        <input name="costOfSales" type="number" step="0.01" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Inversi√≥n Marketing</label>
                                        <input name="marketingInvestment" type="number" step="0.01" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Gastos Operacionales</label>
                                        <input name="expenses" type="number" step="0.01" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Meses Per√≠odo</label>
                                        <input name="months" type="number" required defaultValue="3" className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                </div>
                            </div>

                            <div className="border-t border-gray-700 pt-6 mb-6">
                                <h3 className="text-lg font-bold text-white mb-4">Datos Operacionales</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Empleados</label>
                                        <input name="employees" type="number" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Leads Generados</label>
                                        <input name="leads" type="number" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Ventas Cerradas</label>
                                        <input name="sales" type="number" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Clientes Totales</label>
                                        <input name="customers" type="number" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-1">Clientes Recurrentes</label>
                                        <input name="returningCustomers" type="number" required className="w-full px-4 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-purple-500 focus:outline-none" />
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <button type="submit" className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition">
                                    üöÄ Calcular KPIs
                                </button>
                                <button type="button" onClick={onCancel} className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function KPIResults({ report, onBack, onExportPDF }) {
            const specialist = AISpecialists.find(s => s.id === report.assignedAI);

            const getMetricClass = (severity) => {
                switch(severity) {
                    case 'excellent': return 'kpi-excellent';
                    case 'good': return 'kpi-good';
                    case 'warning': return 'kpi-warning';
                    case 'critical': return 'kpi-critical';
                    default: return '';
                }
            };

            const getMetricIcon = (severity) => {
                switch(severity) {
                    case 'excellent': return 'üåü';
                    case 'good': return '‚úÖ';
                    case 'warning': return '‚ö†Ô∏è';
                    case 'critical': return 'üö®';
                    default: return 'üìä';
                }
            };

            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-white">{report.companyName}</h2>
                            <p className="text-gray-400">{report.departmentName && `${report.departmentName} ‚Ä¢ `}{report.period}</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => onExportPDF(report)} className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                üìÑ Exportar PDF
                            </button>
                            <button onClick={onBack} className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
                                ‚Üê Volver
                            </button>
                        </div>
                    </div>

                    <div className="mb-6 bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <div className="flex items-center gap-3">
                            <span className={`ai-badge ai-${report.assignedAI}`}>{specialist?.name}</span>
                            <span className="text-gray-400 text-sm">An√°lisis realizado {getTimeAgo(report.createdAt)}</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {report.insights?.map((insight, idx) => (
                            <div key={idx} className={`kpi-card bg-gray-800 rounded-lg p-6 border border-gray-700 ${getMetricClass(insight.severity)}`}>
                                <div className="flex items-start gap-3">
                                    <div className="text-3xl">{getMetricIcon(insight.severity)}</div>
                                    <div className="flex-1">
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className="text-lg font-bold text-white">{insight.metric}</h3>
                                            <span className="text-2xl font-bold text-blue-400">{insight.value}</span>
                                        </div>
                                        <p className="text-sm text-gray-300 mb-3">{insight.message}</p>
                                        <div className="bg-gray-900 rounded p-3 border-l-4 border-purple-500">
                                            <p className="text-xs font-semibold text-purple-300 mb-1">üí° Recomendaci√≥n</p>
                                            <p className="text-sm text-gray-400">{insight.recommendation}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="mt-8 bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">üìä Todos los KPIs</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">ROI Marketing</p>
                                <p className="text-2xl font-bold text-white">{report.kpiResults.roiMarketing}%</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Margen Bruto</p>
                                <p className="text-2xl font-bold text-white">{report.kpiResults.grossMargin}%</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Conversi√≥n</p>
                                <p className="text-2xl font-bold text-white">{report.kpiResults.conversionRate}%</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Retenci√≥n</p>
                                <p className="text-2xl font-bold text-white">{report.kpiResults.retentionRate}%</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Productividad</p>
                                <p className="text-2xl font-bold text-white">${report.kpiResults.productivityPerEmployee}</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Burn Rate</p>
                                <p className="text-2xl font-bold text-white">${report.kpiResults.burnRate}</p>
                            </div>
                            <div className="bg-gray-700 rounded p-4 text-center">
                                <p className="text-sm text-gray-400 mb-1">Crecimiento</p>
                                <p className="text-2xl font-bold text-white">{report.kpiResults.revenueGrowth}%</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MAIN DASHBOARD
        // ============================================
        function SynapsisDashboard() {
            const [mainModule, setMainModule] = useState('home'); // 'home', 'projects' or 'kpi'
            const [kpiView, setKpiView] = useState('dashboard'); // 'dashboard', 'form', 'results'
            const [kpiReports, setKpiReports] = useState([]);
            const [selectedReport, setSelectedReport] = useState(null);
            const [showPDFFlash, setShowPDFFlash] = useState(false);


            // ============================================
            // EV OPS CONTEXTO GLOBAL (selector + deep links)
            // ============================================
            const [evStations, setEvStations] = useState([]);
            const [evSelectedStationId, setEvSelectedStationId] = useState('');
            const [evSelectedConnectorId, setEvSelectedConnectorId] = useState('');
            const [evLastAction, setEvLastAction] = useState(null); // { station, taskId, projectId }
            const [evFocusStationId, setEvFocusStationId] = useState(''); // foco temporal para mapa (no filtra por defecto)


            useEffect(() => {
                const saved = StorageOps.loadAllKPIReports();
                setKpiReports(saved);
            }, []);

            // Carga estaciones EV para selector global
            useEffect(() => {
                const sts = StorageOps.loadAllEVStations();
                setEvStations(sts);
                if (sts.length && !evSelectedStationId) {
                    setEvSelectedStationId(sts[0].id);
                }
            }, []);

            // Conector por defecto al cambiar estaci√≥n
            useEffect(() => {
                const st = evStations.find(s => s.id === evSelectedStationId) || evStations[0];
                if (!st) return;
                const firstConn = (st.connectors && st.connectors[0]) ? st.connectors[0] : '';
                const connectors = st.connectors || [];
                const needsReset = !evSelectedConnectorId || (connectors.length && !connectors.includes(evSelectedConnectorId));
                if (needsReset) setEvSelectedConnectorId(firstConn);
            }, [evSelectedStationId, evStations]);

            const handleCalculate = (data, ai) => {
                const kpiResults = calculateKPIs(data);
                const insights = analyzeKPIs(kpiResults, ai);
                
                const report = {
                    id: `kpi-${Date.now()}`,
                    ...data,
                    kpiResults,
                    insights,
                    assignedAI: ai,
                    createdAt: new Date().toISOString()
                };

                StorageOps.saveKPIReport(report);
                const updated = [report, ...kpiReports];
                setKpiReports(updated);
                setSelectedReport(report);
                setKpiView('results');
            };

            const handleDeleteReport = (reportId) => {
                if (confirm('¬øEliminar este an√°lisis?')) {
                    StorageOps.deleteKPIReport(reportId);
                    const updated = kpiReports.filter(r => r.id !== reportId);
                    setKpiReports(updated);
                }
            };

            const handleExportPDF = (report) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('An√°lisis KPI - Protocolo Sinapsis', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Empresa: ${report.companyName}`, 20, 35);
                if (report.departmentName) {
                    doc.text(`Departamento: ${report.departmentName}`, 20, 42);
                }
                doc.text(`Per√≠odo: ${report.period}`, 20, 49);
                
                const specialist = AISpecialists.find(s => s.id === report.assignedAI);
                doc.text(`Especialista: ${specialist?.name}`, 20, 56);

                doc.setFontSize(14);
                doc.text('KPIs Principales:', 20, 70);
                
                doc.setFontSize(11);
                let y = 80;
                doc.text(`ROI Marketing: ${report.kpiResults.roiMarketing}%`, 25, y);
                doc.text(`Margen Bruto: ${report.kpiResults.grossMargin}%`, 25, y + 7);
                doc.text(`Tasa de Conversi√≥n: ${report.kpiResults.conversionRate}%`, 25, y + 14);
                doc.text(`Tasa de Retenci√≥n: ${report.kpiResults.retentionRate}%`, 25, y + 21);
                doc.text(`Productividad: $${report.kpiResults.productivityPerEmployee}`, 25, y + 28);
                doc.text(`Crecimiento Revenue: ${report.kpiResults.revenueGrowth}%`, 25, y + 35);

                y += 50;
                doc.setFontSize(14);
                doc.text('Insights y Recomendaciones:', 20, y);
                
                doc.setFontSize(10);
                y += 10;
                report.insights?.forEach((insight, idx) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${idx + 1}. ${insight.metric}:`, 25, y);
                    doc.text(`   ${insight.message}`, 25, y + 5);
                    doc.text(`   Recomendaci√≥n: ${insight.recommendation}`, 25, y + 10);
                    y += 20;
                });

                doc.save(`kpi-${report.companyName}-${Date.now()}.pdf`);
                
                setShowPDFFlash(true);
                setTimeout(() => setShowPDFFlash(false), 2000);
            };

            
            const selectedEVStation = evStations.find(s => s.id === evSelectedStationId) || evStations[0] || null;

            const goEvOps = (stationId) => {
                if (stationId) {
                    setEvSelectedStationId(stationId);
                    setEvFocusStationId(stationId);
                    // Limpia el foco para no ‚Äúencerrar‚Äù el mapa en una sola estaci√≥n
                    window.setTimeout(() => setEvFocusStationId(''), 450);
                }
                setMainModule('evops');
            };

            const goEvKpi = (station) => {
                if (station && station.id) setEvSelectedStationId(station.id);
                setKpiView('ev');
                setMainModule('kpi');
            };

            const computeEVKPIs = (stations, stationId) => {
    const scope = stationId ? stations.filter(s => s.id === stationId) : stations;
    const total = scope.length || 0;

    const isBusy = (s) => s.status === 'occupied' || s.status === 'queue';
    const safeNum = (v) => (Number.isFinite(+v) ? +v : 0);

    const available = scope.filter(s => s.status === 'available').length;
    const occupied = scope.filter(s => s.status === 'occupied').length;
    const queued = scope.filter(s => s.status === 'queue').length;
    const offline = scope.filter(s => s.status === 'offline').length;
    const busy = scope.filter(isBusy).length;

    const avgOcc = total ? (scope.reduce((sum, s) => sum + safeNum(s.occupancy), 0) / total) : 0;
    const avgQueue = total ? (scope.reduce((sum, s) => sum + safeNum(s.queue), 0) / total) : 0;
    const avgOccBusy = busy ? (scope.filter(isBusy).reduce((sum, s) => sum + safeNum(s.occupancy), 0) / busy) : 0;

    const nominalKW = total ? scope.reduce((sum, s) => sum + safeNum(s.powerKW), 0) : 0;
    const utilizedKW = total ? scope.reduce((sum, s) => sum + (safeNum(s.powerKW) * (safeNum(s.occupancy) / 100)), 0) : 0;
    const utilizationPowerPct = nominalKW > 0 ? (utilizedKW / nominalKW) * 100 : 0;

    const queueTotal = total ? scope.reduce((sum, s) => sum + safeNum(s.queue), 0) : 0;

    const percentile = (arr, p) => {
        if (!arr.length) return 0;
        const a = [...arr].sort((x,y) => x - y);
        const idx = (a.length - 1) * p;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (lo === hi) return a[lo];
        return a[lo] + (a[hi] - a[lo]) * (idx - lo);
    };

    const queueArr = scope.map(s => safeNum(s.queue));
    const occArr = scope.map(s => safeNum(s.occupancy));
    const queueP95 = percentile(queueArr, 0.95);
    const occP95 = percentile(occArr, 0.95);

    const availabilityPct = total ? (available / total) * 100 : 0;
    const busyPct = total ? (busy / total) * 100 : 0;

    const topCongestion = [...scope]
        .sort((a,b) => safeNum(b.queue) - safeNum(a.queue))
        .slice(0, Math.min(5, scope.length))
        .map(s => ({
            id: s.id,
            name: s.name,
            comuna: s.comuna || '',
            status: s.status,
            queue: safeNum(s.queue),
            occupancy: safeNum(s.occupancy),
            powerKW: safeNum(s.powerKW),
        }));

    const byComuna = Object.entries(scope.reduce((acc, s) => {
        const k = (s.comuna || '‚Äî');
        acc[k] = acc[k] || {comuna: k, total: 0, available: 0, busy: 0, offline: 0, queueTotal: 0};
        acc[k].total += 1;
        if (s.status === 'available') acc[k].available += 1;
        if (isBusy(s)) acc[k].busy += 1;
        if (s.status === 'offline') acc[k].offline += 1;
        acc[k].queueTotal += safeNum(s.queue);
        return acc;
    }, {})).map(([_, v]) => ({
        ...v,
        availabilityPct: v.total ? (v.available / v.total) * 100 : 0,
        busyPct: v.total ? (v.busy / v.total) * 100 : 0,
        avgQueue: v.total ? (v.queueTotal / v.total) : 0
    })).sort((a,b) => b.total - a.total);

    const byConnector = Object.entries(scope.reduce((acc, s) => {
        const conns = Array.isArray(s.connectors) ? s.connectors : [];
        conns.forEach(c => { acc[c] = (acc[c] || 0) + 1; });
        return acc;
    }, {})).map(([connector, count]) => ({connector, count})).sort((a,b)=>b.count-a.count);

    return {
        stationId: stationId || null,
        total,
        available,
        occupied,
        queued,
        offline,
        busy,
        availabilityPct,
        busyPct,
        avgOcc,
        avgOccBusy,
        occP95,
        avgQueue,
        queueP95,
        queueTotal,
        nominalKW,
        utilizedKW,
        utilizationPowerPct,
        topCongestion,
        byComuna,
        byConnector,
    };
};

const evK = computeEVKPIs(evStations, evSelectedStationId);

            const exportEVKPIsAsJSON = (evK) => {
    const payload = {
        scope: evK.stationId ? 'station' : 'city',
        generatedAt: new Date().toISOString(),
        stationId: evK.stationId,
        kpis: {
            total: evK.total,
            available: evK.available,
            occupied: evK.occupied,
            queued: evK.queued,
            offline: evK.offline,
            busy: evK.busy,
            availabilityPct: evK.availabilityPct,
            busyPct: evK.busyPct,
            avgOcc: evK.avgOcc,
            avgOccBusy: evK.avgOccBusy,
            occP95: evK.occP95,
            avgQueue: evK.avgQueue,
            queueP95: evK.queueP95,
            queueTotal: evK.queueTotal,
            nominalKW: evK.nominalKW,
            utilizedKW: evK.utilizedKW,
            utilizationPowerPct: evK.utilizationPowerPct,
        },
        topCongestion: evK.topCongestion,
        byComuna: evK.byComuna,
        byConnector: evK.byConnector,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = evK.stationId ? `sinapsis-ev-kpis-${evK.stationId}.json` : `sinapsis-ev-kpis-ciudad.json`;
    a.click();
    URL.revokeObjectURL(url);
};

const exportEVKPIsAsCSV = (stations, evK) => {
    const scope = evK.stationId ? stations.filter(s => s.id === evK.stationId) : stations;

    // 1) Resumen KPI (una fila)
    const summaryHeaders = [
        'scope','stationId','total','available','occupied','queued','offline','busy',
        'availabilityPct','busyPct','avgOcc','avgOccBusy','occP95','avgQueue','queueP95','queueTotal',
        'nominalKW','utilizedKW','utilizationPowerPct','generatedAt'
    ];
    const summaryRow = [
        evK.stationId ? 'station' : 'city',
        evK.stationId || '',
        evK.total, evK.available, evK.occupied, evK.queued, evK.offline, evK.busy,
        evK.availabilityPct.toFixed(2), evK.busyPct.toFixed(2),
        evK.avgOcc.toFixed(2), evK.avgOccBusy.toFixed(2), evK.occP95.toFixed(2),
        evK.avgQueue.toFixed(2), evK.queueP95.toFixed(2), evK.queueTotal,
        evK.nominalKW.toFixed(2), evK.utilizedKW.toFixed(2), evK.utilizationPowerPct.toFixed(2),
        new Date().toISOString()
    ];

    // 2) Detalle por estaci√≥n (para Excel)
    const detailHeaders = ['id','name','comuna','status','powerKW','occupancy','queue','connectors','lastUpdate','lat','lng','address'];
    const detailRows = scope.map(s => detailHeaders.map(h => {
        const v = (h === 'connectors') ? (Array.isArray(s.connectors) ? s.connectors.join('|') : '') : (s[h] ?? '');
        return JSON.stringify(v);
    }).join(','));

    const sections = [
        '# KPI_RESUMEN',
        summaryHeaders.join(','),
        summaryRow.map(v => JSON.stringify(v)).join(','),
        '',
        '# ESTACIONES_DETALLE',
        detailHeaders.join(','),
        ...detailRows
    ].join('\n');

    const blob = new Blob([sections], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = evK.stationId ? `sinapsis-ev-kpis-${evK.stationId}.csv` : `sinapsis-ev-kpis-ciudad.csv`;
    a.click();
    URL.revokeObjectURL(url);
};

const exportEVAsJSON = (stations, stationId) => {
                const scope = stationId ? stations.filter(s => s.id === stationId) : stations;
                const blob = new Blob([JSON.stringify(scope, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = stationId ? `sinapsis-ev-${stationId}.json` : `sinapsis-ev-santiago.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const exportEVAsCSV = (stations, stationId) => {
                const scope = stationId ? stations.filter(s => s.id === stationId) : stations;
                const headers = ['id','name','comuna','address','status','powerKW','occupancy','queue','connectors','lastUpdate','lat','lng'];
                const rows = scope.map(s => headers.map(h => JSON.stringify(s[h] ?? '')).join(','));
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = stationId ? `sinapsis-ev-${stationId}.csv` : `sinapsis-ev-santiago.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

return (
                <div className="min-h-screen p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="mb-8 text-center">
                            <h1 className="text-4xl font-bold gradient-text mb-2">Protocolo Sinapsis v0.9</h1>
                            <p className="text-gray-400">Sistema de Orquestaci√≥n IA Multi-Especialista</p>
                            <p className="text-sm text-gray-500 mt-1">Activa Consultores - COMPLETE Edition Demo</p>
                        </div>

                        {/* Main Navigation */}
                        <div className="flex justify-center gap-4 mb-8">
                            <button
                                onClick={() => setMainModule('home')}
                                className={`main-nav-tab ${mainModule === 'home' ? 'active' : ''}`}
                            >
                                üè† Dashboard Home
                            </button>
                            <button
                                onClick={() => setMainModule('projects')}
                                className={`main-nav-tab ${mainModule === 'projects' ? 'active' : ''}`}
                            >
                                üéØ Proyectos & Tareas
                            </button>
                            <button
                                onClick={() => setMainModule('evops')}
                                className={`main-nav-tab ${mainModule === 'evops' ? 'active' : ''}`}
                            >
                                ‚ö° EV Ops Carga
                            </button>
                            <button
                                onClick={() => setMainModule('evdata')}
                                className={`main-nav-tab ${mainModule === 'evdata' ? 'active' : ''}`}
                            >
                                üß© EV Data Hub
                            </button>
                            <button
                                onClick={() => { setKpiView('dashboard'); setMainModule('kpi'); }}
                                className={`main-nav-tab ${mainModule === 'kpi' ? 'active' : ''}`}
                            >
                                üìä KPI Analytics
                            </button>
                        </div>

                        {/* Modules */}
                        {mainModule === 'home' && <HomeModule />}
                        {mainModule === 'projects' && (
                            <div>
                                {evLastAction?.station && (
                                    <div className="mb-6 bg-gray-900 border border-gray-700 rounded-xl p-4">
                                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                            <div>
                                                <div className="text-white font-semibold">üé´ Ticket EV creado ‚Üí Proyectos & Tareas</div>
                                                <div className="text-sm text-gray-300">
                                                    Estaci√≥n: <span className="font-semibold">{evLastAction.station.name}</span>
                                                    {' '}¬∑ Estado: <span className="font-semibold">{evLastAction.station.status}</span>
                                                    {' '}¬∑ SIMULATED
                                                </div>
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                <button
                                                    onClick={() => goEvOps(evLastAction.station.id)}
                                                    className="px-4 py-2 bg-yellow-700 text-white rounded-lg text-sm font-semibold hover:bg-yellow-800 transition"
                                                >
                                                    ‚ö° Volver a EV Ops
                                                </button>
                                                <button
                                                    onClick={() => setMainModule('evdata')}
                                                    className="px-4 py-2 bg-blue-700 text-white rounded-lg text-sm font-semibold hover:bg-blue-800 transition"
                                                >
                                                    üß© EV Data Hub
                                                </button>
                                                <button
                                                    onClick={() => setEvLastAction(null)}
                                                    className="px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg text-sm font-semibold hover:bg-gray-700 transition"
                                                >
                                                    ‚úÖ Ocultar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <ProjectsModule />
                            </div>
                        )}
                        {mainModule === 'evops' && (
                            <EvOpsModule
                                onGoProjects={(payload) => {
                                    setEvLastAction(payload || null);
                                    if (payload && payload.station && payload.station.id) {
                                        setEvSelectedStationId(payload.station.id);
                                    }
                                    setMainModule('projects');
                                }}
                                onGoKpi={(st) => goEvKpi(st)}
                                selectedStationId={evSelectedStationId}
                                onSelectStation={(id) => setEvSelectedStationId(id)}
                                focusStationId={evFocusStationId}
                            />
                        )}

                        {mainModule === 'evdata' && (
                            <EvDataHubModule
                                selectedStationId={evSelectedStationId}
                                onSelectStation={(id) => setEvSelectedStationId(id)}
                                onGoEvOps={(id) => goEvOps(id)}
                                onGoKpiAnalytics={() => { setKpiView('dashboard'); setMainModule('kpi'); }}
                                                                onGoKpiEvOps={(id) => { if (id) setEvSelectedStationId(id); setKpiView('ev'); setMainModule('kpi'); }}
                                onGoProjects={() => setMainModule('projects')}
                            />
                        )}


                        {mainModule === 'kpi' && (
                            <div>
                                {/* KPI Sub-navigation */}
                                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                                    <div className="text-sm text-gray-400">
                                        Contexto EV: <span className="text-white font-semibold">{selectedEVStation?.name || '‚Äî'}</span>
                                        <span className="text-gray-500"> ¬∑ Conector: </span><span className="text-white font-semibold">{evSelectedConnectorId || '‚Äî'}</span>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        <button
                                            onClick={() => setKpiView('ev')}
                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${kpiView === 'ev' ? 'bg-yellow-700 text-white' : 'bg-gray-800 border border-gray-700 text-white hover:bg-gray-700'}`}
                                        >
                                            ‚ö° KPIs EV
                                        </button>
                                        <button
                                            onClick={() => setKpiView('dashboard')}
                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${kpiView !== 'ev' ? 'bg-purple-700 text-white' : 'bg-gray-800 border border-gray-700 text-white hover:bg-gray-700'}`}
                                        >
                                            üè¢ KPI Empresa
                                        </button>
                                        <button
                                            onClick={() => goEvOps(evSelectedStationId)}
                                            className="px-4 py-2 bg-gray-900 border border-gray-700 text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition"
                                        >
                                            ‚ö° EV Ops
                                        </button>
                                    </div>
                                </div>

                                {kpiView === 'ev' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-white">‚ö° KPIs EV ‚Äî Operaci√≥n de carga</h2>
                                            <div className="flex flex-wrap gap-2">
    <button
        onClick={() => exportEVKPIsAsJSON(evK)}
        className="px-4 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg text-sm font-semibold transition"
    >
        ‚§ì KPIs JSON
    </button>
    <button
        onClick={() => exportEVKPIsAsCSV(evStations, evK)}
        className="px-4 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg text-sm font-semibold transition"
    >
        ‚§ì KPIs CSV
    </button>
    <button
        onClick={() => exportEVAsJSON(evStations, evSelectedStationId)}
        className="px-4 py-2 bg-gray-900 border border-gray-700 text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition"
    >
        ‚§ì Datos JSON
    </button>
    <button
        onClick={() => exportEVAsCSV(evStations, evSelectedStationId)}
        className="px-4 py-2 bg-gray-900 border border-gray-700 text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition"
    >
        ‚§ì Datos CSV / Excel
    </button>
    <button
        onClick={() => goEvOps(evSelectedStationId)}
        className="px-4 py-2 bg-yellow-700 text-white rounded-lg text-sm font-semibold hover:bg-yellow-800 transition"
    >
        ‚ö° Volver EV Ops
    </button>
</div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Estaciones</div>
        <div className="text-2xl font-bold text-white">{evK.total}</div>
        <div className="text-xs text-gray-500 mt-1">alcance actual</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Disponibilidad</div>
        <div className="text-2xl font-bold text-white">{evK.availabilityPct.toFixed(1)}%</div>
        <div className="text-xs text-gray-500 mt-1">{evK.available} disponibles</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Ocupadas</div>
        <div className="text-2xl font-bold text-white">{evK.occupied}</div>
        <div className="text-xs text-gray-500 mt-1">{evK.busyPct.toFixed(0)}% en uso</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">En cola</div>
        <div className="text-2xl font-bold text-white">{evK.queued}</div>
        <div className="text-xs text-gray-500 mt-1">cola total: {evK.queueTotal}</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Offline</div>
        <div className="text-2xl font-bold text-white">{evK.offline}</div>
        <div className="text-xs text-gray-500 mt-1">puntos fuera de l√≠nea</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Utilizaci√≥n potencia</div>
        <div className="text-2xl font-bold text-white">{evK.utilizationPowerPct.toFixed(0)}%</div>
        <div className="text-xs text-gray-500 mt-1">{evK.utilizedKW.toFixed(0)} / {evK.nominalKW.toFixed(0)} kW</div>
    </div>
</div>

<div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-6">
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Ocupaci√≥n prom.</div>
        <div className="text-2xl font-bold text-white">{evK.avgOcc.toFixed(0)}%</div>
        <div className="text-xs text-gray-500 mt-1">todas las estaciones</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Ocupaci√≥n prom. (busy)</div>
        <div className="text-2xl font-bold text-white">{evK.avgOccBusy.toFixed(0)}%</div>
        <div className="text-xs text-gray-500 mt-1">solo ocupadas/cola</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Ocupaci√≥n P95</div>
        <div className="text-2xl font-bold text-white">{evK.occP95.toFixed(0)}%</div>
        <div className="text-xs text-gray-500 mt-1">pico t√≠pico</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Cola prom.</div>
        <div className="text-2xl font-bold text-white">{evK.avgQueue.toFixed(1)}</div>
        <div className="text-xs text-gray-500 mt-1">personas/veh√≠culos</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Cola P95</div>
        <div className="text-2xl font-bold text-white">{evK.queueP95.toFixed(1)}</div>
        <div className="text-xs text-gray-500 mt-1">cola alta</div>
    </div>
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="text-xs text-gray-400 mb-1">Potencia nominal</div>
        <div className="text-2xl font-bold text-white">{evK.nominalKW.toFixed(0)} kW</div>
        <div className="text-xs text-gray-500 mt-1">‚àë powerKW</div>
    </div>
</div>

<div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div className="bg-gray-900 rounded-lg p-5 border border-gray-700">
        <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-bold text-white">üö¶ Top congesti√≥n</h3>
            <div className="text-xs text-gray-400">por cola</div>
        </div>
        <div className="space-y-2">
            {evK.topCongestion.map((s, i) => (
                <div key={s.id} className="flex items-center justify-between bg-gray-950/40 border border-gray-800 rounded-lg px-3 py-2">
                    <div className="min-w-0">
                        <div className="text-sm text-white font-semibold truncate">{i+1}. {s.name}</div>
                        <div className="text-xs text-gray-400 truncate">{s.comuna} ¬∑ {s.status}</div>
                    </div>
                    <div className="text-right ml-3">
                        <div className="text-sm text-white font-bold">cola {s.queue}</div>
                        <div className="text-xs text-gray-400">{s.occupancy.toFixed(0)}% ¬∑ {s.powerKW.toFixed(0)} kW</div>
                    </div>
                </div>
            ))}
        </div>
    </div>

    <div className="bg-gray-900 rounded-lg p-5 border border-gray-700">
        <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-bold text-white">üó∫Ô∏è Distribuci√≥n por comuna</h3>
            <div className="text-xs text-gray-400">top 6</div>
        </div>
        <div className="space-y-2">
            {evK.byComuna.slice(0,6).map((c) => (
                <div key={c.comuna} className="flex items-center justify-between bg-gray-950/40 border border-gray-800 rounded-lg px-3 py-2">
                    <div className="text-sm text-white font-semibold truncate">{c.comuna}</div>
                    <div className="text-right ml-3">
                        <div className="text-sm text-white font-bold">{c.total} pts</div>
                        <div className="text-xs text-gray-400">{c.availabilityPct.toFixed(0)}% disp ¬∑ cola {c.avgQueue.toFixed(1)}</div>
                    </div>
                </div>
            ))}
        </div>
        {evK.byConnector.length > 0 && (
            <div className="mt-4 pt-3 border-t border-gray-800">
                <div className="text-xs text-gray-400 mb-2">Conectores (conteo)</div>
                <div className="flex flex-wrap gap-2">
                    {evK.byConnector.map(x => (
                        <span key={x.connector} className="px-2 py-1 text-xs bg-gray-800 border border-gray-700 text-white rounded-lg">
                            {x.connector}: {x.count}
                        </span>
                    ))}
                </div>
            </div>
        )}
    </div>
</div>

<div className="bg-gray-900 rounded-lg p-6 border border-gray-700">
                                            <h3 className="text-lg font-bold text-white mb-2">Formatos de salida (lo que el operador se lleva)</h3>
                                            <div className="text-sm text-gray-300 leading-relaxed">
                                                ‚Ä¢ <span className="font-semibold text-white">API JSON</span> para apps y mapas (estado, cola, fallas, energ√≠a).<br/>
                                                ‚Ä¢ <span className="font-semibold text-white">Eventos</span> (webhooks / bus) para alertas y automatizaci√≥n operacional.<br/>
                                                ‚Ä¢ <span className="font-semibold text-white">CSV/Excel</span> para continuidad (y sacar Excel de a poco, sin trauma).<br/>
                                                ‚Ä¢ <span className="font-semibold text-white">PDF</span> para comit√©/gerencia con KPIs y trazabilidad de tickets.
                                            </div>
                                            <div className="text-xs text-gray-500 mt-3">
                                                Nota: esta versi√≥n usa datos <span className="font-semibold">SIMULATED</span>. En piloto se conecta al backend/CSMS (OCPP/API) sin tocar cada cargador, salvo casos especiales.
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {kpiView === 'dashboard' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-white">üìä An√°lisis KPI</h2>
                                            <button
                                                onClick={() => setKpiView('form')}
                                                className="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                            >
                                                ‚ûï Nuevo An√°lisis
                                            </button>
                                        </div>

                                        {kpiReports.length === 0 ? (
                                            <div className="bg-gray-800 rounded-lg p-12 border border-gray-700 text-center">
                                                <div className="text-6xl mb-4">üìä</div>
                                                <h3 className="text-2xl font-bold text-white mb-4">No hay an√°lisis todav√≠a</h3>
                                                <p className="text-gray-400 mb-6">Comienza creando tu primer an√°lisis KPI</p>
                                                <button
                                                    onClick={() => setKpiView('form')}
                                                    className="px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-800 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-purple-900 transition"
                                                >
                                                    üöÄ Crear Primer An√°lisis
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                {kpiReports.map(report => {
                                                    const specialist = AISpecialists.find(s => s.id === report.assignedAI);
                                                    const criticalCount = report.insights?.filter(i => i.severity === 'critical').length || 0;
                                                    
                                                    return (
                                                        <div key={report.id} className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-purple-500 transition task-card">
                                                            <div className="flex items-start justify-between mb-4">
                                                                <div>
                                                                    <h3 className="text-xl font-bold text-white">{report.companyName}</h3>
                                                                    <p className="text-sm text-gray-400">
                                                                        {report.departmentName && `${report.departmentName} ‚Ä¢ `}
                                                                        {report.period}
                                                                    </p>
                                                                    <p className="text-xs text-gray-500 mt-1">
                                                                        {getTimeAgo(report.createdAt)} ‚Ä¢ {specialist?.name}
                                                                    </p>
                                                                </div>
                                                                {criticalCount > 0 && (
                                                                    <span className="px-3 py-1 bg-red-900 text-red-200 text-xs font-semibold rounded-full">
                                                                        {criticalCount} cr√≠tico(s)
                                                                    </span>
                                                                )}
                                                            </div>

                                                            <div className="grid grid-cols-3 gap-3 mb-4">
                                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                                    <p className="text-xs text-gray-400">ROI</p>
                                                                    <p className="text-lg font-bold text-white">{report.kpiResults.roiMarketing}%</p>
                                                                </div>
                                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                                    <p className="text-xs text-gray-400">Margen</p>
                                                                    <p className="text-lg font-bold text-white">{report.kpiResults.grossMargin}%</p>
                                                                </div>
                                                                <div className="bg-gray-700 rounded p-2 text-center">
                                                                    <p className="text-xs text-gray-400">Retenci√≥n</p>
                                                                    <p className="text-lg font-bold text-white">{report.kpiResults.retentionRate}%</p>
                                                                </div>
                                                            </div>

                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => {
                                                                        setSelectedReport(report);
                                                                        setKpiView('results');
                                                                    }}
                                                                    className="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-sm font-semibold"
                                                                >
                                                                    Ver Detalles
                                                                </button>
                                                                <button
                                                                    onClick={() => handleExportPDF(report)}
                                                                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm"
                                                                >
                                                                    üìÑ
                                                                </button>
                                                                <button
                                                                    onClick={() => handleDeleteReport(report.id)}
                                                                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm"
                                                                >
                                                                    üóëÔ∏è
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {kpiView === 'form' && (
                                    <KPIForm
                                        onCalculate={handleCalculate}
                                        onCancel={() => setKpiView('dashboard')}
                                    />
                                )}

                                {kpiView === 'results' && selectedReport && (
                                    <KPIResults
                                        report={selectedReport}
                                        onBack={() => setKpiView('dashboard')}
                                        onExportPDF={handleExportPDF}
                                    />
                                )}
                            </div>
                        )}

                        {showPDFFlash && (
                            <div className="fixed top-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg success-flash z-50">
                                ‚úÖ PDF Generado
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SynapsisDashboard />);
        
        console.log('üü¢ ===== PROTOCOLO SINAPSIS v0.9 COMPLETE INICIADO =====');
    </script>




<div id="sinapsisPrintReport">
  <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
    <div>
      <h1><span class="brandA">Activa</span> <span class="brandC">Consultores</span></h1>
      <div class="muted">Protocolo Sinapsis v0.9.1 (EV Ops) ¬∑ Reporte comit√© (PDF)</div>
    </div>
    <div class="muted" id="spr_meta"></div>
  </div>

  <div style="margin-top:10px">
    <div style="font-weight:900" id="spr_scope"></div>
    <div class="muted" id="spr_ticket"></div>
  </div>

  <div class="grid" id="spr_kpis"></div>

  <div style="margin-top:14px">
    <div class="sectionTitle" id="spr_detail_title">Detalle por estaci√≥n</div>
    <div class="muted" id="spr_detail_hint" style="margin-top:2px">Ordenado por criticidad (offline ‚Üí cola ‚Üí ocupaci√≥n).</div>
    <div class="stationTable" id="spr_stations"></div>
  </div>


  <div style="margin-top:14px" class="muted">
    Nota: datos simulados (sin datos personales). En piloto real: integraci√≥n v√≠a backend / OCPP / APIs.
  </div>
</div>


<script>
(function(){
  function markNoPrint(){
    // mark all direct children as no-print except the print report
    Array.from(document.body.children).forEach(el=>{
      if (el && el.id !== "sinapsisPrintReport") el.classList.add("no-print");
    });
  }
  document.addEventListener("DOMContentLoaded", markNoPrint);
})();
</script>








<script>
/* --- EV Data Hub v5: KPI fix (ocupaci√≥n) + export esquema (kpis+stations) + PDF comit√© (v0.9.1) --- */
(function () {
  const QS = new URLSearchParams(location.search);
  const state = window.__sinapsisEVState = window.__sinapsisEVState || {
    scope: QS.get("scope") || "city",          // "city" | "station"
    station: QS.get("station") || null        // "ev-scl-06" etc
  };

  const SEEDED_STATIONS = [{"id": "ev-scl-01", "name": "Red EV - SCL 01", "comuna": "Las Condes", "address": "Punto 01, Las Condes, Santiago", "lat": -33.404654, "lng": -70.58125, "powerKW": 50, "status": "queue", "queue": 5, "occupancy": 69, "connectors": ["CCS2"]}, {"id": "ev-scl-02", "name": "Red EV - SCL 02", "comuna": "Providencia", "address": "Punto 02, Providencia, Santiago", "lat": -33.427325, "lng": -70.610699, "powerKW": 150, "status": "occupied", "queue": 0, "occupancy": 61, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-03", "name": "Red EV - SCL 03", "comuna": "Santiago Centro", "address": "Punto 03, Santiago Centro, Santiago", "lat": -33.448237, "lng": -70.663189, "powerKW": 150, "status": "offline", "queue": 0, "occupancy": 12, "connectors": ["Type2"]}, {"id": "ev-scl-04", "name": "Red EV - SCL 04", "comuna": "√ëu√±oa", "address": "Punto 04, √ëu√±oa, Santiago", "lat": -33.45453, "lng": -70.591519, "powerKW": 50, "status": "queue", "queue": 4, "occupancy": 74, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-05", "name": "Red EV - SCL 05", "comuna": "La Reina", "address": "Punto 05, La Reina, Santiago", "lat": -33.440858, "lng": -70.531717, "powerKW": 50, "status": "occupied", "queue": 0, "occupancy": 94, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-06", "name": "Red EV - SCL 06", "comuna": "Maip√∫", "address": "Punto 06, Maip√∫, Santiago", "lat": -33.512834, "lng": -70.766336, "powerKW": 22, "status": "queue", "queue": 1, "occupancy": 81, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-07", "name": "Red EV - SCL 07", "comuna": "Puente Alto", "address": "Punto 07, Puente Alto, Santiago", "lat": -33.620679, "lng": -70.564575, "powerKW": 100, "status": "offline", "queue": 0, "occupancy": 2, "connectors": ["Type2"]}, {"id": "ev-scl-08", "name": "Red EV - SCL 08", "comuna": "La Florida", "address": "Punto 08, La Florida, Santiago", "lat": -33.538645, "lng": -70.573644, "powerKW": 150, "status": "queue", "queue": 3, "occupancy": 79, "connectors": ["CHAdeMO", "CCS2"]}, {"id": "ev-scl-09", "name": "Red EV - SCL 09", "comuna": "Estaci√≥n Central", "address": "Punto 09, Estaci√≥n Central, Santiago", "lat": -33.458144, "lng": -70.693863, "powerKW": 50, "status": "offline", "queue": 0, "occupancy": 3, "connectors": ["CHAdeMO", "CCS2"]}, {"id": "ev-scl-10", "name": "Red EV - SCL 10", "comuna": "Quilicura", "address": "Punto 10, Quilicura, Santiago", "lat": -33.343355, "lng": -70.70934, "powerKW": 60, "status": "offline", "queue": 0, "occupancy": 16, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-11", "name": "Red EV - SCL 11", "comuna": "Las Condes", "address": "Punto 11, Las Condes, Santiago", "lat": -33.404744, "lng": -70.571055, "powerKW": 50, "status": "available", "queue": 0, "occupancy": 0, "connectors": ["CHAdeMO", "CCS2"]}, {"id": "ev-scl-12", "name": "Red EV - SCL 12", "comuna": "Providencia", "address": "Punto 12, Providencia, Santiago", "lat": -33.428156, "lng": -70.610494, "powerKW": 50, "status": "offline", "queue": 0, "occupancy": 3, "connectors": ["CCS2"]}, {"id": "ev-scl-13", "name": "Red EV - SCL 13", "comuna": "Santiago Centro", "address": "Punto 13, Santiago Centro, Santiago", "lat": -33.445078, "lng": -70.654616, "powerKW": 50, "status": "queue", "queue": 3, "occupancy": 77, "connectors": ["CHAdeMO", "CCS2"]}, {"id": "ev-scl-14", "name": "Red EV - SCL 14", "comuna": "√ëu√±oa", "address": "Punto 14, √ëu√±oa, Santiago", "lat": -33.447772, "lng": -70.58972, "powerKW": 22, "status": "occupied", "queue": 0, "occupancy": 74, "connectors": ["CHAdeMO", "CCS2"]}, {"id": "ev-scl-15", "name": "Red EV - SCL 15", "comuna": "La Reina", "address": "Punto 15, La Reina, Santiago", "lat": -33.445372, "lng": -70.554014, "powerKW": 50, "status": "occupied", "queue": 0, "occupancy": 77, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-16", "name": "Red EV - SCL 16", "comuna": "Maip√∫", "address": "Punto 16, Maip√∫, Santiago", "lat": -33.511505, "lng": -70.743564, "powerKW": 50, "status": "occupied", "queue": 0, "occupancy": 78, "connectors": ["CCS2"]}, {"id": "ev-scl-17", "name": "Red EV - SCL 17", "comuna": "Puente Alto", "address": "Punto 17, Puente Alto, Santiago", "lat": -33.60512, "lng": -70.573831, "powerKW": 150, "status": "occupied", "queue": 0, "occupancy": 60, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-18", "name": "Red EV - SCL 18", "comuna": "La Florida", "address": "Punto 18, La Florida, Santiago", "lat": -33.553312, "lng": -70.55508, "powerKW": 100, "status": "available", "queue": 0, "occupancy": 0, "connectors": ["Type2"]}, {"id": "ev-scl-19", "name": "Red EV - SCL 19", "comuna": "Estaci√≥n Central", "address": "Punto 19, Estaci√≥n Central, Santiago", "lat": -33.453861, "lng": -70.689167, "powerKW": 50, "status": "occupied", "queue": 0, "occupancy": 76, "connectors": ["Type2", "CCS2"]}, {"id": "ev-scl-20", "name": "Red EV - SCL 20", "comuna": "Quilicura", "address": "Punto 20, Quilicura, Santiago", "lat": -33.352686, "lng": -70.723457, "powerKW": 150, "status": "queue", "queue": 5, "occupancy": 76, "connectors": ["CHAdeMO", "CCS2"]}];

  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  // Demo tickets
  const TKEY = "sinapsisTickets_v1";
  function loadTickets(){ try { return JSON.parse(localStorage.getItem(TKEY) || "{}"); } catch { return {}; } }
  function saveTickets(obj){ localStorage.setItem(TKEY, JSON.stringify(obj)); }
  function openTicket(stId){
    if (!stId) return null;
    const t = loadTickets();
    t[stId] = {
      ticket_open: true,
      ticket_id: "TK-" + Date.now(),
      ticket_status: "open",
      ticket_type: "incidente_operacional",
      created_at: new Date().toISOString()
    };
    saveTickets(t);
    return t[stId];
  }
  function getTicket(stId){ const t = loadTickets(); return stId ? (t[stId] || null) : null; }

  function syncURL(){
    const url = new URL(location.href);
    url.searchParams.set("scope", state.scope);
    if (state.station) url.searchParams.set("station", state.station);
    else url.searchParams.delete("station");
    history.replaceState(null, "", url.toString());
  }

  function getHubRoot(){
    return document.getElementById("ev-data-hub") || document.querySelector("[data-ev-data-hub]");
  }

  function buildCatalog(){
    const m = new Map();
    // Prefer seeded stations from demo exports (20)
    if (Array.isArray(SEEDED_STATIONS) && SEEDED_STATIONS.length) {
      SEEDED_STATIONS.forEach(s=>{
        if (!s.id) return;
        m.set(s.id, {
          id: s.id,
          name: s.name || s.id,
          comuna: s.comuna || null,
          address: s.address || null,
          lat: s.lat ?? null,
          lng: s.lng ?? null,
          powerKW: s.powerKW ?? null,
          status: s.status || "available",
          queue: s.queue ?? 0,
          occupancy: s.occupancy ?? 0,
          connectors: s.connectors || []
        });
      });
      return m;
    }
    // Minimal fallback
    [["ev-scl-06","Red EV - SCL 06","Maip√∫"],["ev-scl-01","Red EV - SCL 01","Las Condes"]].forEach(([id,name,comuna])=>{
      m.set(id, {id,name,comuna,address:null,lat:null,lng:null,powerKW:22,status:"available",queue:0,occupancy:0,connectors:[]});
    });
    return m;
  }

  function ensureControls(){
    const hub = getHubRoot();
    if (!hub) return;
    if (hub.querySelector("[data-ev-scope-controls]")) return;

    const controls = document.createElement("div");
    controls.setAttribute("data-ev-scope-controls","1");
    controls.style.display="flex";
    controls.style.gap="10px";
    controls.style.flexWrap="wrap";
    controls.style.alignItems="center";
    controls.style.margin="10px 0 12px 0";

    controls.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="font-weight:800;opacity:.9">Vista</div>
        <button type="button" class="btn" data-scope="city">Ciudad</button>
        <button type="button" class="btn" data-scope="station">Estaci√≥n</button>

        <div style="display:flex;gap:8px;align-items:center;margin-left:10px">
          <div style="font-weight:800;opacity:.9">Estaci√≥n</div>
          <select id="evStationSelect" class="mono" style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#e8eefc;min-width:240px">
            <option value="">(elige estaci√≥n)</option>
          </select>
        </div>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button type="button" class="btn" id="btnExportJSON">Export JSON</button>
        <button type="button" class="btn" id="btnExportCSV">Export CSV</button>
        <button type="button" class="btn" id="btnPDF">PDF comit√©</button>
      </div>
    `;

    const h2 = hub.querySelector("h2, h3") || hub.firstElementChild;
    if (h2 && h2.parentElement === hub) h2.insertAdjacentElement("afterend", controls);
    else hub.prepend(controls);

    const catalog = buildCatalog();
    const select = $("#evStationSelect", hub);

    Array.from(catalog.values())
      .sort((a,b)=>`${a.id}`.localeCompare(`${b.id}`))
      .forEach(st=>{
        const opt = document.createElement("option");
        opt.value = st.id;
        opt.textContent = `${st.id.toUpperCase()} ¬∑ ${st.comuna || ""}`.trim();
        select.appendChild(opt);
      });

    if (state.station && catalog.has(state.station)) select.value = state.station;

    function highlight(){
      $all("button[data-scope]", controls).forEach(b=>{
        const scope = b.getAttribute("data-scope");
        const active = (scope===state.scope);
        b.style.outline = active ? "2px solid rgba(255,255,255,.25)" : "none";
        b.classList.toggle("primary", active && scope==="city");
        b.classList.toggle("orange", active && scope==="station");
      });
      select.style.borderColor = (state.scope==="station" && !state.station) ? "rgba(255,122,26,.55)" : "rgba(255,255,255,.12)";
    }

    controls.addEventListener("click",(e)=>{
      const btn = e.target.closest("button[data-scope]");
      if (!btn) return;
      state.scope = btn.getAttribute("data-scope");
      syncURL(); render(); highlight();
    });
    select.addEventListener("change",()=>{
      state.station = select.value || null;
      if (state.station) state.scope = "station";
      syncURL(); render(); highlight();
    });

    $("#btnExportJSON", controls).addEventListener("click",()=>{
      const payload = buildPayload();
      download(JSON.stringify(payload, null, 2), exportName("kpis", "json"), "application/json");
    });
    $("#btnExportCSV", controls).addEventListener("click",()=>{
      const payload = buildPayload();
      download(toCSV(payload.stations || []), exportName("stations", "csv"), "text/csv;charset=utf-8");
    });
    $("#btnPDF", controls).addEventListener("click",()=>{
      const payload = buildPayload();
      fillPrint(payload);
      window.print();
    });

    highlight();
  }

  function exportName(prefix, ext){
    const scope = (state.scope==="station" && state.station) ? "station" : "city";
    return `sinapsis-ev-${prefix}-${scope}.${ext}`;
  }

  function download(text, filename, mime){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // --- KPI rules (fix) ---
  function computeKpisForStation(st){
    const status = (st.status || "").toLowerCase();
    const occupancy = Number.isFinite(+st.occupancy) ? +st.occupancy : 0;
    const queue = Number.isFinite(+st.queue) ? +st.queue : 0;
    const power = Number.isFinite(+st.powerKW) ? +st.powerKW : 0;

    const isOffline = status === "offline";
    const isBusy = status === "occupied" || status === "queue";

    return {
      availability_pct: (status === "available") ? 100 : 0,
      occupancy_pct: (isBusy ? occupancy : (status === "available" ? 0 : occupancy)),
      offline_count: isOffline ? 1 : 0,
      avg_queue: queue,
      active_power_kw_est: (isBusy && power > 0) ? power : 0
    };
  }

  function computeKpisCity(stations){
    const n = stations.length || 1;
    const avail = stations.map(s => (String(s.status||"").toLowerCase()==="available") ? 100 : 0);
    const occ = stations.map(s => Number.isFinite(+s.occupancy) ? +s.occupancy : 0);
    const off = stations.map(s => (String(s.status||"").toLowerCase()==="offline") ? 1 : 0);
    const q = stations.map(s => Number.isFinite(+s.queue) ? +s.queue : 0);
    const p = stations.map(s => {
      const status = String(s.status||"").toLowerCase();
      const busy = status==="occupied" || status==="queue";
      const pw = Number.isFinite(+s.powerKW) ? +s.powerKW : 0;
      return (busy && pw>0) ? pw : 0;
    });

    const avg = arr => Math.round((arr.reduce((a,x)=>a+x,0)/n)*10)/10;

    return {
      availability_pct: avg(avail),
      occupancy_pct: avg(occ),
      offline_count: off.reduce((a,x)=>a+x,0),
      avg_queue: avg(q),
      active_power_kw_est: Math.round(p.reduce((a,x)=>a+x,0))
    };
  }

  function buildPayload(){
    const catalog = buildCatalog();
    const now = new Date().toISOString();
    const scope = (state.scope==="station" && state.station) ? "station" : "city";
    const selected_station_id = (scope==="station") ? state.station : null;

    // Stations list
    let stations = [];
    if (scope === "station") {
      const st = catalog.get(state.station);
      if (st) stations = [st];
    } else {
      stations = Array.from(catalog.values());
    }

    // Attach ticket fields into stations (optional, demo)
    stations = stations.map(s => {
      const t = getTicket(s.id);
      return {
        ...s,
        lastUpdate: s.lastUpdate || now,
        source: s.source || "SIMULATED",
        ticket_open: !!t?.ticket_open,
        ticket_id: t?.ticket_id || null,
        ticket_status: t?.ticket_status || null,
        ticket_type: t?.ticket_type || null,
        ticket_created_at: t?.created_at || null
      };
    });

    const kpis = (scope==="station" && stations[0]) ? computeKpisForStation(stations[0]) : computeKpisCity(stations);

    return {
      platform: "Protocolo Sinapsis v0.9.1 (EV Ops)",
      generated_at: now,
      scope,
      selected_station_id,
      kpis,
      stations
    };
  }

  function toCSV(stations){
    const headers = ["id","name","comuna","address","status","powerKW","occupancy","queue","lastUpdate","lat","lng","ticket_open","ticket_id","ticket_status","ticket_type","ticket_created_at"];
    const esc = (v)=>{ if (v===null||v===undefined) return ""; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; };
    const lines = [headers.join(",")];
    (stations||[]).forEach(r=>{
      lines.push(headers.map(h=>esc(r[h])).join(","));
    });
    return lines.join("\n");
  }

  function render(){
    const hub = getHubRoot();
    if (!hub) return;

    let box = hub.querySelector("[data-ev-kpi-box]");
    if (!box) {
      box = document.createElement("div");
      box.setAttribute("data-ev-kpi-box","1");
      box.style.marginTop="10px";
      hub.appendChild(box);
    }

    const payload = buildPayload();
    const title = payload.scope === "station"
      ? (payload.stations[0] ? `Estaci√≥n: ${payload.stations[0].id.toUpperCase()} ¬∑ ${payload.stations[0].comuna || ""}` : "Estaci√≥n")
      : "Ciudad: vista general";

    const t = (payload.scope==="station" && payload.stations[0]) ? getTicket(payload.stations[0].id) : null;
    const ticketLine = t ? `Ticket: ${t.ticket_id} ¬∑ ${t.ticket_status} ¬∑ ${t.ticket_type}` : "";

    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div style="font-weight:900;font-size:14px">${title}</div>
        <div style="color:rgba(255,255,255,.65);font-size:12px">SIMULATED ¬∑ Sin PII ¬∑ Integraci√≥n: backend / OCPP / APIs</div>
      </div>
      ${ticketLine ? `<div style="margin-top:6px;color:rgba(255,255,255,.75);font-size:12px;font-weight:800">${ticketLine}</div>` : ``}
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px">
        ${kpiCard("Disponibilidad", payload.kpis.availability_pct + "%")}
        ${kpiCard("Ocupaci√≥n", payload.kpis.occupancy_pct + "%")}
        ${kpiCard("Cola prom.", payload.kpis.avg_queue)}
        ${kpiCard("Offline", payload.kpis.offline_count)}
        ${kpiCard("Potencia activa", payload.kpis.active_power_kw_est + " kW")}
      </div>
    `;
  }

  function fillPrint(payload){
    const meta = document.getElementById("spr_meta");
    if (meta) meta.textContent = new Date(payload.generated_at).toLocaleString();

    const scopeEl = document.getElementById("spr_scope");
    const ticketEl = document.getElementById("spr_ticket");
    const kpiBox = document.getElementById("spr_kpis");

    const detailTitle = document.getElementById("spr_detail_title");
    const detailHint = document.getElementById("spr_detail_hint");
    const stationsBox = document.getElementById("spr_stations");

    const isStation = payload.scope === "station" && payload.stations && payload.stations[0];

    if (isStation) {
      const st = payload.stations[0];
      if (scopeEl) scopeEl.textContent = `Estaci√≥n: ${st.id.toUpperCase()} ¬∑ ${st.comuna || ""}`;
      const t = getTicket(st.id);
      if (ticketEl) ticketEl.textContent = t ? `Ticket ${t.ticket_id} ¬∑ ${t.ticket_status} ¬∑ ${t.ticket_type} ¬∑ ${t.created_at}` : "Sin ticket activo";
      if (detailTitle) detailTitle.style.display = "none";
      if (detailHint) detailHint.style.display = "none";
      if (stationsBox) stationsBox.style.display = "none";
    } else {
      if (scopeEl) scopeEl.textContent = "Ciudad: vista general";
      if (ticketEl) ticketEl.textContent = "Resumen + detalle (todas las estaciones)";
      if (detailTitle) detailTitle.style.display = "block";
      if (detailHint) detailHint.style.display = "block";
      if (stationsBox) stationsBox.style.display = "block";
    }

    if (kpiBox) {
      kpiBox.innerHTML = `
        <div class="kpi"><div class="t">Disponibilidad</div><div class="v">${payload.kpis.availability_pct}%</div></div>
        <div class="kpi"><div class="t">Ocupaci√≥n</div><div class="v">${payload.kpis.occupancy_pct}%</div></div>
        <div class="kpi"><div class="t">Cola prom.</div><div class="v">${payload.kpis.avg_queue}</div></div>
        <div class="kpi"><div class="t">Offline</div><div class="v">${payload.kpis.offline_count}</div></div>
        <div class="kpi"><div class="t">Potencia activa</div><div class="v">${payload.kpis.active_power_kw_est} kW</div></div>
      `;

    // ---- Ciudad detallada: agrega tabla por estaci√≥n al PDF (paginable) ----
    try{
      const report = document.getElementById("sinapsisPrintReport");
      if (report){
        // Limpia detalle previo
        const prev = report.querySelector("[data-spr-detail]");
        if (prev) prev.remove();

        if (!(payload.scope === "station")){
          const wrap = document.createElement("div");
          wrap.setAttribute("data-spr-detail","1");
          wrap.innerHTML = buildDetailTableHTML(payload.stations || []);
          report.appendChild(wrap);
        }
      }
    }catch(err){ console.error(err); }
    }

    // City detailed list
    if (!isStation && stationsBox) {
      const stations = Array.isArray(payload.stations) ? payload.stations.slice() : [];

      // Criticidad: offline (1) > cola (queue) > ocupaci√≥n
      function toNum(x){ return Number.isFinite(+x) ? +x : 0; }
      function statusRank(s){
        s = String(s||"").toLowerCase();
        if (s === "offline") return 3;
        if (s === "queue") return 2;
        if (s === "occupied") return 1;
        return 0; // available
      }

      stations.sort((a,b)=>{
        const ra = statusRank(a.status), rb = statusRank(b.status);
        if (rb !== ra) return rb - ra;
        const qa = toNum(a.queue), qb = toNum(b.queue);
        if (qb !== qa) return qb - qa;
        const oa = toNum(a.occupancy), ob = toNum(b.occupancy);
        if (ob !== oa) return ob - oa;
        return String(a.id||"").localeCompare(String(b.id||""), "es");
      });

      const badgeClass = (s)=>{
        s = String(s||"").toLowerCase();
        if (s === "offline") return "badge b-offline";
        if (s === "queue") return "badge b-queue";
        if (s === "occupied") return "badge b-occupied";
        return "badge b-available";
      };

      const head = `
        <div class="row head">
          <div class="cell">Estaci√≥n</div>
          <div class="cell">Comuna</div>
          <div class="cell">Estado</div>
          <div class="cell small">Cola</div>
          <div class="cell small">Ocup.</div>
          <div class="cell small">kW</div>
        </div>
      `;

      const rows = stations.map(st=>{
        const id = (st.id||"").toUpperCase();
        const comuna = st.comuna || "";
        const estado = String(st.status||"available").toLowerCase();
        const q = toNum(st.queue);
        const occ = toNum(st.occupancy);
        const pw = toNum(st.powerKW);
        return `
          <div class="row">
            <div class="cell">${id}</div>
            <div class="cell">${comuna}</div>
            <div class="cell"><span class="${badgeClass(estado)}">${estado}</span></div>
            <div class="cell small">${q}</div>
            <div class="cell small">${occ}%</div>
            <div class="cell small">${pw}</div>
          </div>
        `;
      }).join("");

      stationsBox.innerHTML = head + rows;
    }
  }

  // Hook: crear ticket en estaci√≥n 06 -> ev-scl-06
  function hookTicket(){
    document.addEventListener("click",(e)=>{
      const el = e.target.closest("button, a");
      if (!el) return;
      const txt = (el.textContent||"").trim().toLowerCase();
      const isCreate = txt.includes("ticket") && (txt.includes("crear") || txt.includes("create"));
      if (!isCreate) return;

      const ctx = el.closest("[data-station-id]") || el.closest(".station") || el.closest(".card");
      let id = null;
      if (ctx && ctx.getAttribute) id = (ctx.getAttribute("data-station-id")||"").trim() || null;

      if (!id && ctx) {
        const t = (ctx.textContent||"");
        const m = t.match(/Estaci[o√≥]n\s*0?(\d+)/i);
        if (m) id = `ev-scl-${m[1].padStart(2,"0")}`;
      }

      if (id) {
        openTicket(id);
        state.station = id;
        state.scope = "station";
        syncURL();
        render();
      }
    }, true);
  }

  
  function patchLegacyExportPanel(){
    // Busca el panel existente "Exportar datos" (JSON KPIs / CSV Estaciones) y le agrega PDF + wiring.
    const buttons = Array.from(document.querySelectorAll("button"));
    const btnJSON = buttons.find(b => (b.textContent||"").trim().toLowerCase() === "json kpis");
    const btnCSV  = buttons.find(b => (b.textContent||"").trim().toLowerCase() === "csv estaciones");
    if (!btnJSON || !btnCSV) return;

    // Evita doble binding
    if (btnJSON.dataset.sinapsisBound === "1") return;
    btnJSON.dataset.sinapsisBound = "1";
    btnCSV.dataset.sinapsisBound  = "1";

    btnJSON.addEventListener("click", (e)=>{ e.preventDefault(); try{
      const payload = buildPayload();
      download(JSON.stringify(payload, null, 2), exportName("kpis", "json"), "application/json");
    }catch(err){ console.error(err); }});

    btnCSV.addEventListener("click", (e)=>{ e.preventDefault(); try{
      const payload = buildPayload();
      download(toCSV(payload.stations || []), exportName("stations", "csv"), "text/csv;charset=utf-8");
    }catch(err){ console.error(err); }});

    // Agrega PDF si no existe
    const already = buttons.find(b => (b.textContent||"").toLowerCase().includes("pdf"));
    if (already) return;

    const btnPDF = document.createElement("button");
    btnPDF.type = "button";
    btnPDF.className = btnCSV.className || "btn";
    btnPDF.textContent = "PDF comit√©";
    btnPDF.style.marginLeft = "8px";
    btnCSV.insertAdjacentElement("afterend", btnPDF);

    btnPDF.addEventListener("click",(e)=>{ e.preventDefault(); try{
      const payload = buildPayload();
      fillPrint(payload);
      window.print();
    }catch(err){ console.error(err); }});
  }

  function buildDetailTableHTML(stations){
    const rows = (stations||[]).slice().sort((a,b)=>{
      const ao = String(a.status||"").toLowerCase()==="offline" ? 1:0;
      const bo = String(b.status||"").toLowerCase()==="offline" ? 1:0;
      if (bo!==ao) return bo-ao;
      const bq = Number.isFinite(+b.queue)?+b.queue:0;
      const aq = Number.isFinite(+a.queue)?+a.queue:0;
      if (bq!==aq) return bq-aq;
      const boc = Number.isFinite(+b.occupancy)?+b.occupancy:0;
      const aoc = Number.isFinite(+a.occupancy)?+a.occupancy:0;
      return boc-aoc;
    });

    const th = (t)=>`<th style="text-align:left;padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.12);font-size:12px">${t}</th>`;
    const td = (v)=>`<td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);font-size:12px">${v??""}</td>`;
    const badge = (s)=>{
      const st = String(s||"").toLowerCase();
      const bg = st==="offline" ? "rgba(220,38,38,.12)" : (st==="queue" ? "rgba(245,158,11,.12)" : (st==="occupied" ? "rgba(99,102,241,.12)" : "rgba(16,185,129,.12)"));
      const fg = st==="offline" ? "#b91c1c" : (st==="queue" ? "#92400e" : (st==="occupied" ? "#3730a3" : "#065f46"));
      return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${bg};color:${fg};font-weight:800">${st||"‚Äî"}</span>`;
    };

    const trs = rows.map(r=>{
      return `<tr style="break-inside:avoid;page-break-inside:avoid">
        ${td(`<span style="font-weight:900">${(r.id||"").toUpperCase()}</span><div style="opacity:.7">${r.comuna||""}</div>`)}
        ${td(badge(r.status))}
        ${td(Number.isFinite(+r.queue)?+r.queue:0)}
        ${td((Number.isFinite(+r.occupancy)?+r.occupancy:0) + "%")}
        ${td((Number.isFinite(+r.powerKW)?+r.powerKW:0) + " kW")}
      </tr>`;
    }).join("");

    return `
      <div style="margin-top:14px">
        <div style="font-weight:900;font-size:14px;margin-bottom:4px">Detalle por estaci√≥n</div>
        <div style="font-size:12px;opacity:.75;margin-bottom:8px">Ordenado por criticidad (offline ‚Üí cola ‚Üí ocupaci√≥n).</div>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr>
            ${th("Estaci√≥n")}
            ${th("Estado")}
            ${th("Cola")}
            ${th("Ocupaci√≥n")}
            ${th("kW")}
          </tr></thead>
          <tbody>${trs}</tbody>
        </table>
      </div>
    `;
  }

function init(){ ensureControls(); hookTicket(); patchLegacyExportPanel(); render(); }

  document.addEventListener("DOMContentLoaded", init);
  window.addEventListener("hashchange", init);
})();
</script>

</body>
</html>
